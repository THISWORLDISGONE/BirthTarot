<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>塔羅生命靈數與運勢計算器</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out forwards;
        }
        
        /* Tarot card image styles */
        .tarot-card-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .tarot-card-image:hover {
            transform: scale(1.05);
        }

        /* Loading state */
        .image-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        body {
            background-color: #f3e8ff; /* Light purple background for the whole page */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, Fragment, useMemo, useRef } = React;

        // --- SHARED ICON COMPONENTS ---
        const Calendar = () => <span>📅</span>;
        const Sparkles = ({ className }) => <span className={className}>✨</span>;
        const Hash = ({ className }) => <span className={className}>#</span>;
        const User = ({ className }) => <span className={className}>👤</span>;
        const BookOpen = () => <span>📖</span>;
        const ChevronDown = ({ className }) => <span className={className}>▼</span>;
        const ChevronUp = ({ className }) => <span className={className}>▲</span>;
        const Gift = ({ className }) => <span className={className}>🎁</span>;
        const Shield = ({ className }) => <span className={className}>🛡️</span>;
        const HeartIcon = ({ className }) => <span className={className}>💖</span>;
        const UsersIcon = ({ className }) => <span className={className}>👥</span>;
        const MoonIcon = ({ className }) => <span className={className}>🌙</span>;
        const StarIcon = ({ className }) => <span className={className}>⭐</span>;
        const AlertCircleIcon = ({ className }) => <span className={className}>⚠️</span>;
        const InfoIcon = ({ className }) => <span className={className}>ℹ️</span>;
        const BrainIcon = () => <span>🧠</span>;
        const ClockIcon = () => <span>🕰️</span>;
        const SunIcon = () => <span>☀️</span>;
        const TargetIcon = () => <span>🎯</span>;

        // --- SHARED CARD DETAILS ---
        const cardDetails = {
          0: {
            name: '愚者',
            shortMeaning: '純真、勇氣、無限可能、新的開始',
            soulMission: '0號愚者作為靈魂卡牌，您的核心使命是學習無條件信任宇宙的引導，帶著純真的心和無畏的勇氣去擁抱生命中無限的可能性，並活在當下。您的內在潛能包括不受限的創造力、敏銳的直覺以及與神性直接連結的能力。您的靈魂渴望自由探索，並在每一次冒險中發現深刻的智慧與生命的喜悅。',
            personalityTrait: '個性上，愚者展現為充滿好奇心、樂觀積極且富有感染力的冒險家。您傾向於憑直覺行事，勇於嘗試新事物，不喜歡墨守成規或受到束縛。在心理層面，代表著與內在孩童的純真連結及潛意識的原始智慧。您的天賦在於創新思維、開闢新道路和為周圍帶來輕鬆活潑的氛圍。',
            challenges: '愚者的主要挑戰在於可能缺乏長遠規劃、容易因一時衝動而忽略現實後果、難以承擔長期的責任或完成既定任務。有時可能過於天真爛漫，不願面對現實的嚴肅面，或在自由與紀律之間難以取得平衡。需要學習在擁抱自由的同時，也腳踏實地，並為自己的選擇與行動負責，避免不必要的風險。'
          },
          1: {
            name: '魔術師',
            shortMeaning: '創造力、意志力、顯化、溝通',
            soulMission: '1號魔術師的靈魂使命是成為連接天地能量的橋樑，學習運用意志力和專注力，將靈感與潛能顯化為物質現實。您的靈魂渴望掌握創造的法則，自信地運用天賦與資源去實現目標。內在潛能包括強大的創造力、集中的意志、以及整合多元能力的智慧。',
            personalityTrait: '個性上，魔術師展現出自信、魅力、足智多謀和目標導向的特質。您善於溝通說服，擁有良好的規劃與執行能力，能夠有效地運用資源達成目的。在心理層面，象徵著有意識的自我、清晰的思維和實現個人意志的力量。您的天賦在於化腐朽為神奇，將不可能變為可能。',
            challenges: '魔術師的挑戰在於可能過度依賴個人意志，導致操控傾向、自負或不擇手段。有時可能因為想掌控一切而感到焦慮，或因害怕失敗而不敢真正施展才華。需要警惕語言的誤用（如欺騙或誇大），並學習將個人意志與更高的智慧相結合，服務於更廣泛的益處，而非僅僅滿足自我。'
          },
          2: {
            name: '女祭司',
            shortMeaning: '直覺、潛意識、神秘智慧、靜默',
            soulMission: '2號女祭司的靈魂使命是深入探索內在世界，連結潛意識的智慧與宇宙的奧秘，成為內在與外在知識的守護者與傳遞者。您的靈魂渴望發展深邃的直覺力，學會聆聽內心的聲音，並在靜默中獲得啟示。靈性潛能包括超凡的直覺、洞察力和接收宇宙訊息的能力。',
            personalityTrait: '個性上，女祭司表現為神秘、內斂、沉靜且具有深度的特質。您傾向於觀察反思，喜歡獨處，對深層次的心靈交流和神秘事物感興趣。在心理層面，代表潛意識的智慧、陰性原則以及對未知領域的探索。您的天賦在於洞察事物的本質，擁有超越表象的理解力。',
            challenges: '女祭司的挑戰在於可能過度內向，與現實生活產生脫節，或因情感壓抑而顯得冷漠。有時可能因害怕被誤解而隱藏真實的感受與智慧，或在直覺與邏輯之間掙扎。需要學習將內在的智慧適當地表達和應用於現實世界，並在獨處與社交之間找到平衡，避免孤立。'
          },
          3: {
            name: '女帝',
            shortMeaning: '豐饒、母性、創造、滋養與感官享受',
            soulMission: '3號女帝的靈魂使命是學習無條件的愛與創造，成為生命力、豐盛與美的管道。您的靈魂渴望體驗並分享生活中的喜悅與美好，滋養自己與他人，並與大自然和諧共處。內在潛能是源源不絕的創造力、強大的療癒能量以及與萬物生長的深度連結。',
            personalityTrait: '個性上，女帝展現出溫暖、關愛、慷慨且富有創造力的照顧者特質。您熱愛美好事物，享受感官體驗，並具有將事物變得更美好的天賦。在心理層面，象徵創造力、無條件的愛、以及接納與包容。您擅長營造和諧舒適的環境，并能自然地吸引豐盛。',
            challenges: '女帝的挑戰在於可能過度沉溺於物質享受、過度保護或控制所愛的人，或因情感氾濫而缺乏邊界感。有時可能在付出與接受之間失衡，或因害怕匱乏而緊抓不放。需要學習設定健康的界線，平衡自我照顧與照顧他人，並將創造力導向建設性的方向，避免懶散或過度放縱。'
          },
          4: {
            name: '皇帝',
            shortMeaning: '權威、結構、穩定、領導與秩序',
            soulMission: '4號皇帝的靈魂使命是學習建立穩固的結構與秩序，成為有智慧、負責任且公正的領導者。您的靈魂渴望在物質世界中創造穩定與安全，並運用權威來保護與建設。需要發展自律、責任感、策略思維以及在混亂中建立秩序的智慧。',
            personalityTrait: '個性上，皇帝展現出權威、務實、有組織且具決斷力的領導者特質。您重視規則、效率和目標達成，擁有強大的執行力與責任感。在心理層面，代表陽性原則、邏輯思維、以及掌控局面的能力。您的天賦在於建立系統、制定計劃並有效地管理資源。',
            challenges: '皇帝的挑戰在於可能過於固執、僵化或控制慾過強，導致專斷或缺乏彈性。有時可能因害怕失控而過度壓抑情感，或因追求完美而對自己和他人過於嚴苛。需要學習在權威與仁慈之間取得平衡，聆聽他人的意見，並適應變化，避免因過度強調秩序而扼殺創造力。'
          },
          5: {
            name: '教皇',
            shortMeaning: '精神指引、傳統、教育、信仰與規範',
            soulMission: '5號教皇的靈魂使命是成為智慧的傳承者與道德的指引者，在精神與物質世界之間建立橋樑。您的靈魂渴望探索並分享真理與信仰，遵循並傳播有益的傳統與規範。靈性潛能包括教導能力、諮詢天賦以及對集體智慧的深刻理解。',
            personalityTrait: '個性上，教皇展現出傳統、有原則、重視道德且具有教導傾向的特質。您喜歡探索事物的深層意義，尋求知識，並樂於分享所學。在心理層面，代表集體無意識、良知以及對更高意義的追尋。您通常是值得信賴的顧問，能夠提供有結構的指引。',
            challenges: '教皇的挑戰在於可能過於固守傳統、墨守成規，或變得教條主義、批判性過強。有時可能因害怕偏離既定規範而缺乏創新精神，或將個人信念強加於人。需要學習區分盲從與智慧傳承，保持思想的開放性，並尊重個體的自由意志與不同的人生道路。'
          },
          6: {
            name: '戀人',
            shortMeaning: '愛情、選擇、關係、價值觀與和諧',
            soulMission: '6號戀人的靈魂使命是學習愛的真諦，在關係中實現個人的整合與平衡，並根據內心真實的價值觀做出重要的生命抉擇。您的靈魂渴望體驗深刻的連結與和諧，並在愛中成長。需要發展愛的能力、明智選擇的智慧以及整合內在對立面的能力。',
            personalityTrait: '個性上，戀人展現出魅力、友善、善於交際且重視人際關係的特質。您渴望和諧，注重美感，並傾向於在做決定時考慮他人的感受。在心理層面，代表著整合內心不同面向的過程、對連結的渴望以及價值觀的形成。您通常是受歡迎的，能夠促進團隊合作。',
            challenges: '戀人的挑戰在於可能在重要選擇面前猶豫不決、過度依賴他人或害怕承諾。有時可能因追求表面和諧而犧牲真實感受，或在關係中迷失自我。需要學習為自己的選擇負責，忠於內心的價值觀，即使這意味著可能產生衝突。發展獨立性和清晰的自我認知是重要的課題。'
          },
          7: {
            name: '戰車',
            shortMeaning: '決心、勝利、掌控方向、意志力與行動',
            soulMission: '7號戰車的靈魂使命是學習整合內在的矛盾力量，以堅定的意志力和專注的行動力，克服障礙，朝向明確的目標勇敢前進並獲得成功。您的靈魂渴望體驗掌控自我與環境的力量。靈魂潛能是強大的意志力、自律以及整合對立力量以達成目標的能力。',
            personalityTrait: '個性上，戰車展現出決心堅定、目標導向、充滿自信且富有競爭力的特質。您勇於面對挑戰，行動力強，並渴望獲得勝利與成就。在心理層面，代表著自我控制、意志力的運用以及克服內心衝突。您的天賦在於領導眾人達成艱難的目標。',
            challenges: '戰車的挑戰在於可能變得過度好鬥、缺乏耐心或不顧一切地追求目標而忽略他人的感受與需求。有時可能因意志力過強而顯得固執己見，或因害怕失敗而逃避真正的挑戰。需要學習平衡野心與同情心，控制衝動，並確保行動的方向符合更高的益處，而非僅僅是自我的征服慾。'
          },
          8: {
            name: '力量',
            shortMeaning: '內在力量、勇氣、耐心、慈悲與整合本能',
            soulMission: '8號力量的靈魂使命是學習運用內在真正的力量——源於愛、勇氣、耐心與慈悲的力量，去整合並轉化原始的本能與恐懼。您的靈魂渴望以溫柔而堅定的方式克服挑戰，展現內在的堅韌。靈性潛能包括深厚的內在勇氣、強大的療癒能力和化解衝突的智慧。',
            personalityTrait: '個性上，力量展現出溫和而堅定、富有耐心、同情心且具有安撫人心的特質。您不以外在的強勢取勝，而是以內在的毅力與慈悲影響他人。在心理層面，代表著本能的整合、情緒的成熟以及勇氣與愛的結合。您擅長在困境中保持冷靜與韌性。',
            challenges: '力量的挑戰在於可能過度壓抑自身的需求與情感以維持和平，或因害怕衝突而逃避 notwendige 對抗。有時可能難以設定界線，導致自我消耗或被他人利用。需要學習平衡溫柔與堅定，肯定自我價值，並在適當的時候展現果斷，明白真正的力量並非軟弱。'
          },
          9: {
            name: '隱士',
            shortMeaning: '內省、尋求真理、智慧、指引與獨處',
            soulMission: '9號隱士的靈魂使命是透過深入的內在探索與反思，尋求並獲得深刻的智慧與真理，然後成為他人生命旅程中的指路明燈。您的靈魂渴望在獨處中與內在的導師連結。需要發展在孤獨中汲取智慧的能力，以及用溫和的方式分享洞見的靈性指導能力。',
            personalityTrait: '個性上，隱士展現出內省、沉靜、智慧且喜歡獨處的深度思考者特質。您不追求外在的喧囂，更傾向於探索事物的本質與意義。在心理層面，代表著對內在智慧的追尋、審慎的態度以及獨立思考的能力。您的天賦在於提供深刻的洞見與指導。',
            challenges: '隱士的挑戰在於可能過度孤立自我，與社會脫節，或因過度沉思而變得悲觀、猶豫不前。有時可能因害怕被外界打擾而拒絕與人分享智慧，或因標準過高而顯得挑剔。需要學習在獨處與分享之間找到平衡，將內在の智慧應用於實際生活，並信任他人的成長過程。'
          },
          10: {
            name: '命運之輪',
            shortMeaning: '命運轉變、機會、週期、轉捩點與順應潮流',
            soulMission: '10號命運之輪的靈魂使命是學習理解並接受生命的循環與無常變化，在每一次轉變中找到成長的機會與更深層的意義。您的靈魂渴望順應宇宙的節奏，並在變化中保持中心。靈魂潛能是卓越的適應能力、洞察生命週期的智慧以及把握時機的能力。',
            personalityTrait: '個性上，命運之輪展現出樂觀、適應力強、相信運氣且樂於接受改變的特質。您通常能從容應對突如其來的變化，並从中看到新的可能性。在心理層面，代表著對生命循環的認知、對未知的好奇以及相信一切皆有其時。您擅長抓住機會，隨遇而安。',
            challenges: '命運之輪的挑戰在於可能過度依賴運氣而缺乏主動性，或在面對逆境時感到無力、聽天由命。有時可能因害怕錯過機會而變得焦躁不安，或在不斷的變化中缺乏穩定性與扎根感。需要學習在順應變化的同時，也積極把握可控因素，並從每一次循環中學習經驗，建立內在的定力。'
          },
          11: {
            name: '正義',
            shortMeaning: '公正、平衡、真理、因果法則與責任',
            soulMission: '11號正義的靈魂驅動力是追求絕對的真理、公平與內外的完美平衡。您的生命目標是理解並活出因果法則，為自己的所有思想、言語和行為負起全部責任，並致力於創造一個更公正和諧的世界。您的潛能是清晰的判斷力、無私的客觀性以及維護平衡的能力。',
            personalityTrait: '作為個性卡牌時，您展現出強烈的公平正義感、清晰的邏輯思維和高度的誠實。您重視事實，力求客觀，並期望他人也能如此。在早期可能過於理想化或追求完美，成熟期則能成為他人的道德指南針和可靠的仲裁者，以理服人。',
            challenges: '正義的挑戰在於可能變得過度嚴厲、批判、缺乏彈性或不近人情。對自己或他人可能有不切實際的完美標準，導致過度的自我批評或對他人吹毛求疵。需要學習在理智與情感、公正與慈悲之間取得平衡，理解人性的複雜性，避免陷入僵化的律法主義。'
          },
          12: {
            name: '倒吊人',
            shortMeaning: '犧牲、新視角、等待、臣服與頓悟',
            soulMission: '12號倒吊人的靈魂渴望通過自願的犧牲、放下舊有觀念或暫時的停滯，來獲得更高層次的理解與靈性覺醒。您的生命目標是達到完全的臣服與接納，從从而體驗到宇宙的智慧和內在的平靜。您的潛能是深度的耐心、超越常規的洞察力以及從逆境中轉化智慧的能力。',
            personalityTrait: '個性特徵上，您深具耐心，善於反思，不畏懼從不同的角度看待事物，並且能夠在逆境和等待中成長。早期可能因為觀點獨特而感到與周圍格格不入，成熟後則可能成為具有非凡洞察力的精神導師或引路人，幫助他人看見新的可能性。',
            challenges: '倒吊人的挑戰在於可能陷入拖延、被動等待、自我犧牲到失去自我的境地，或發展出受害者心態。有時可能因過於沉浸在自己的世界而與現實脫節。需要學習區分必要的臣服與無謂的犧牲，並在等待的同時保持積極的內在探索，而非消極地停滯不前。'
          },
          13: {
            name: '死神',
            shortMeaning: '結束與新生、轉變、放下、徹底改變',
            soulMission: '13號死神的靈魂使命是深刻理解並擁抱生命中不斷發生的結束與開始的循環，協助自己和他人勇敢地放下不再服務於成長的人事物，從而迎接必要的轉化與重生。您的潛能是強大的轉化力、不執著的智慧以及引導蛻變的能力。',
            personalityTrait: '個性表現為深具洞察力，不懼怕改變，甚至可能主動尋求或促成深刻的轉變。您往往能看到事物的本質，並勇於ตัด斷不再需要的連結。在他人眼中，您可能是帶來重大轉折點的「催化劑」。早期可能經歷較多變動或分離，成熟後則能成為生命轉化的引導者，幫助他人釋放舊有模式。',
            challenges: '死神的挑戰在於可能因為害怕未知而抗拒必要的改變，或反過來，因為渴望改變而草率地結束關係或事物。有時可能顯得冷酷無情，或因沉溺於過去的失落而難以向前。需要學習以建設性的方式擁抱轉變，區分必要的終結與逃避性的割捨，並在過程中給予自己和他人足夠的哀悼與過渡時間。'
          },
          14: {
            name: '節制',
            shortMeaning: '平衡、調和、整合、耐心與中庸之道',
            soulMission: '14號節制的靈魂尋求在所有層面達到完美的平衡、和諧與整合。您的生命目標是學會在看似對立的力量（如物質與精神、內在與外在、行動與靜默）之間找到中道，並將它們融合成一個和諧的整體。您的潛能是卓越的調解能力、創造性的融合以及身心靈的整合。',
            personalityTrait: '外在表現為一位天生的外交家和調和者，您擁有將不同元素巧妙融合的能力，善於促進群體和諧與合作。您通常心態平和，富有耐心，並能在複雜情況中找到解決方案。您追求的是長期的穩定與和諧，而非短暫的激情。',
            challenges: '節制的挑戰在於可能為了維持表面的和諧而過度妥協，失去自己的立場，或在做決定時顯得猶豫不決，害怕打破平衡。有時可能因為追求完美的中庸而顯得乏味或缺乏激情。需要學習在必要時堅守原則，明白真正的平衡並非一成不變，而是動態的調整過程。'
          },
          15: {
            name: '惡魔',
            shortMeaning: '慾望、束縛、物質主義、陰影面與誘惑',
            soulMission: '15號惡魔的靈魂課題是深入理解並整合自身的陰影面、慾望與恐懼，將其從無意識的束縛轉化為有意識的創造力與生命力。您的生命目標是實現真正的自由，這需要先勇敢面對並接納內心所有被壓抑或否認的部分。您的潛能是強大的生命力、洞察人性深層動機的能力以及轉化束縛的勇氣。',
            personalityTrait: '個性特徵上，您可能充滿激情與活力，直接坦率，對物質世界有強烈的感受力。您可能擁有強大的個人魅力，但也容易受到誘惑或陷入執著。早期可能在放縱與壓抑之間擺盪，成熟後則能學會駕馭自身強大的慾望，將其轉化為創造性的動力。',
            challenges: '惡魔的挑戰在於容易陷入各種形式的成癮（物質、情感、權力等）、執著於不健康的關係或模式、被恐懼所控制，或過度追求物質而忽略精神需求。需要警惕自我欺騙和否認，勇敢面對內心的陰影，並學習區分健康的慾望與有害的沉溺。真正的力量來自於解放，而非束縛。'
          },
          16: {
            name: '塔',
            shortMeaning: '突變、覺醒、解放、舊結構瓦解與真相顯露',
            soulMission: '16號高塔的靈魂使命是勇敢面對並推動必要的瓦解，破除那些建立在虛假、限制性信念或過時結構之上的生活模式，從而為更真實、更穩固的基礎騰出空間，迎來深刻的覺醒與解放。您的潛能是帶來突破性改變的勇氣、洞察真相的能力以及在混亂後重建的力量。',
            personalityTrait: '個性表現為擁有強大意志力，可能是天生的變革者或「真相揭露者」，您的出現往往會無意中或有意地引發周圍環境或人事物的劇烈變動。早期可能經歷較多突如其來的意外或危機，成熟後則能成為他人生命中轉機的製造者，幫助打破僵局。',
            challenges: '高塔的挑戰在於可能經歷頻繁的、戲劇性的生活動盪，或因抗拒改變而讓必要的崩塌更加痛苦。有時可能因過於直接或衝動而造成不必要的破壞。需要學習信任生命中突如其來的變革，即使它們看起來是毀滅性的，並從每一次「倒塌」中汲取教訓，重建更符合真我的生活。'
          },
          17: {
            name: '星星',
            shortMeaning: '希望、靈感、治癒、平靜與精神指引',
            soulMission: '17號星星的靈魂使命是成為他人生命中的希望之光與靈感之源，傳播治癒、平靜與對未來的信心。您的生命目標是在經歷過往的混亂或挑戰後，重新找到內心的純淨與寧靜，並將這份來自宇宙的祝福分享出去。您的潛能是強大的治癒力、深邃的靈性連結以及鼓舞人心的能力。',
            personalityTrait: '個性特質上，您通常樂觀、充滿希望、富有同情心，並可能擁有天生的治癒天賦或藝術才華。您能為周圍的人帶來平靜與安慰，並引導他們看到困境中的光明面。您的靈性成長方向是發展直覺和治癒能力，成為光與愛的工作者。早期可能過於理想化，成熟後則成為他人穩定的靈感源泉。',
            challenges: '星星的挑戰在於可能因為過於理想化而脫離現實，或在給予他人希望時忽略自身的需求，導致耗竭。有時可能因對未來抱持不切實際的幻想而感到失望，或在逆境中失去信心。需要學習在保持希望的同時腳踏實地，並在治癒他人的過程中照顧好自己，讓自己成為清澈的希望管道。'
          },
          18: {
            name: '月亮',
            shortMeaning: '幻象、直覺、潛意識、恐懼與夢境',
            soulMission: '18號月亮的靈魂使命是勇敢地探索潛意識的深邃領域，穿越內心的恐懼與幻象，從而獲得深刻的直覺智慧，並成為連接意識與無意識世界的橋樑。您的生命目標是學會信任內在的指引，即使在迷霧與不確定中。您的潛能是卓越的直覺力、豐富的想像力以及對人性陰影的深刻理解。',
            personalityTrait: '個性敏感、富有同情心、想像力豐富，並具有強烈的直覺力與感受性。您可能對夢境、象徵和神秘事物著迷。您需要學會區分真實的直覺與由恐懼產生的幻象，並勇敢面對內心的不安全感。早期可能容易情緒波動或感到困惑，成熟後則能成為深刻的解夢者或精神嚮導。',
            challenges: '月亮的挑戰在於容易受到環境或他人情緒的影響，陷入焦慮、困惑或自我欺騙。內心的恐懼可能被放大，導致逃避現實或做出非理性選擇。需要學習建立清晰的個人邊界，培養分辨幻象與真相的能力，並有意識地將潛意識的洞見帶入光明之中，而不是被其淹沒。'
          },
          19: {
            name: '太陽',
            shortMeaning: '快樂、成功、活力、清晰與生命力',
            soulMission: '19號太陽的靈魂使命是全然地展現內在的光明、喜悅與生命力，成為純粹的愛與真理的化身，照亮自己和周圍的世界。您的生命目標是活出真實的自我，體驗並分享生命的豐盛與成功。您的潛能是無限的活力、清晰的洞察力、天生的領導魅力以及帶來快樂與啟迪的能力。',
            personalityTrait: '外在表現為樂觀開朗、精力充沛、充滿自信，散發著領袖氣質和溫暖的感染力。您通常能清晰地看到事物的本質，並能以積極的態度面對生活。您的生命課題是學會在任何困境中都能保持內在的光明與樂觀。早期可能顯得天真或自我中心，成熟後則成為他人的重要啟發者與激勵者。',
            challenges: '太陽的挑戰在於可能因為過度自信而變得自負或忽略他人的需求，或因害怕失去光芒而過度追求外界的認可。有時可能因能量過強而顯得咄咄逼人，或因過度樂觀而低估困難。需要學習將個人的光芒與謙遜相結合，照亮他人而非灼傷他人，並在享受成功的同時保持對生命深層意義的覺察。'
          },
          20: {
            name: '審判',
            shortMeaning: '覺醒、重生、召喚、評估與寬恕',
            soulMission: '20號審判的靈魂使命是回應內心深處的召喚，經歷一次深刻的靈性覺醒與重生，放下過去的包袱與評判，從而活出更真實、更有意義的生命。您的目標是協助自己和他人從舊有的限制中解放出來，成為覺醒的催化劑。您的潛能是深刻的轉化力、清晰的內在指引以及促進集體覺醒的能力。',
            personalityTrait: '個性上，您通常具有強烈的使命感，能感知到超越日常生活的更高層次召喚。您可能扮演著喚醒他人、推動革新或進行重要人生評估的角色。您對過去的經歷有著深刻的反思，並尋求從中學習，以邁向新的開始。您重視誠實與自我負責。',
            challenges: '審判的挑戰在於可能過於嚴厲地評判自己或他人，或沉溺於過去的遺憾與悔恨中無法自拔。有時可能因為害怕面對真相而抗拒內心的召喚，或將個人的標準強加於人。需要學習真正的寬恕（對己對人），放下不必要的內疚感，並以慈悲的心態來面對人生的轉型期，擁抱新的可能性。'
          },
          21: {
            name: '世界',
            shortMeaning: '完成、成就、整合、圓滿與宇宙意識',
            soulMission: '21號世界的靈魂使命是追求生命旅程的圓滿完成與深度整合，在所有層面達到和諧、成就與對宇宙意識的了悟。您的生命目標是體驗到生命的完整性，將所學的一切融會貫通，並活在與萬物合一的喜悅之中。您的潛能是實現宏大目標的能力、深廣的包容心以及與宇宙節奏共舞的智慧。',
            personalityTrait: '個性表現為具有開闊的宇宙視野、強大的整合能力和深度的包容心。您能夠理解並欣賞生命的多樣性，並傾向於以整體性的觀點看待事物。您追求的是實質性的成就與內在的圓滿。在生命的某個階段，您可能會感受到一種深刻的完成感與自由。',
            challenges: '世界的挑戰在於在達到一個重要的里程碑後，可能難以開啟新的篇章，或因為過於追求完美而害怕行動。有時可能因為視野過於宏大而忽略了當下的細節，或在整合的過程中感到壓力。需要學習在每一個「完成」之後慶祝並適時放手，迎接新的循環，並理解圓滿是一個持續的、螺旋式上升的過程。'
          },
        };
        
        // --- SHARED CALCULATION FUNCTIONS ---
        const sharedSumDigits = (n) => {
            if (typeof n !== 'number' && typeof n !== 'string') return 0;
            return n.toString().split('').map(Number).reduce((a, b) => a + b, 0);
        };

        const sharedReduceToSingleDigit = (n) => {
            let num = n;
            while (num > 9) {
                num = sharedSumDigits(num);
            }
            return num;
        };
        
        // --- SHARED FORTUNE CARD CALCULATION LOGIC ---
        const sharedCalculateFortuneCards = (birthDate, targetYear, targetMonth) => {
            if (!birthDate || !targetYear || !targetMonth) return { yearlyCard: null, monthlyCard: null };
            
            const [bYear, bMonth, bDay] = birthDate.split('-').map(Number);
            const personalBase = sharedSumDigits(bYear) + bMonth + sharedSumDigits(bDay);
            const yearlyValue = personalBase + sharedSumDigits(targetYear);
            
            // Raw value is 1-22 for internal calculations
            let yearlyCardRaw = (yearlyValue > 0) ? (yearlyValue - 1) % 22 + 1 : 22;
            if (yearlyCardRaw === 0) yearlyCardRaw = 22; 
            // Final card ID for display (0 for Fool)
            const yearlyCardId = yearlyCardRaw === 22 ? 0 : yearlyCardRaw;

            const bDaySimplified = sharedReduceToSingleDigit(bDay);
            const monthlyAdjustment = bMonth + bDaySimplified;
            const monthlyValue = yearlyCardRaw + parseInt(targetMonth, 10) + monthlyAdjustment;
            
            let monthlyCardRaw = (monthlyValue > 0) ? (monthlyValue - 1) % 22 + 1 : 22;
            if (monthlyCardRaw === 0) monthlyCardRaw = 22;
            const monthlyCardId = monthlyCardRaw === 22 ? 0 : monthlyCardRaw;
            
            return { yearlyCard: yearlyCardId, monthlyCard: monthlyCardId };
        };

        // --- SHARED IMAGE PATH HELPER ---
        const cardFileNames = {
          0: '00愚者.png',
          1: '01魔术师.png',
          2: '02女祭祀.png',
          3: '03皇后.png',
          4: '04皇帝.png',
          5: '05教皇.png',
          6: '06恋人.png',
          7: '07战车.png',
          8: '08力量.png',
          9: '09隐士.png',
          10: '10命运之轮.png',
          11: '11正义.png',
          12: '12倒吊人.png',
          13: '13死神.png',
          14: '14节制.png',
          15: '15恶魔.png',
          16: '16高塔.png',
          17: '17星星.png',
          18: '18月亮.png',
          19: '19太阳.png',
          20: '20审判.png',
          21: '21世界.png'
        };

        const sharedGetCardImagePath = (cardId) => {
          if (cardId === null || cardId === undefined) return '';
          const fileName = cardFileNames[cardId];
          if (!fileName) return '';
          
          return `./Tarot Cards/${fileName}`;
        };

        // --- TAROT BIRTH CARDS CALCULATOR (Mary K. Greer System) ---
        const TarotBirthCardsCalculator = () => {
          const [birthDate, setBirthDate] = useState('');
          const [result, setResult] = useState(null);
          const [detailedReport, setDetailedReport] = useState(null);
          const [showProcess, setShowProcess] = useState(false);
          const [showInfo, setShowInfo] = useState(false);
          const [viewMode, setViewMode] = useState('simple');

          const TarotTheoryInfo = () => (
            <div className="mt-8 p-6 bg-white rounded-lg shadow-md space-y-6 text-gray-700 transition-all duration-500 ease-in-out">
              <h2 className="text-2xl font-bold text-purple-800 text-center flex items-center justify-center gap-2">
                <BookOpen /> 塔羅生命靈數系統深度解碼
              </h2>
              
              <section>
                <h3 className="text-xl font-semibold text-purple-700 mb-2">靈魂藍圖與個性表現的深度解碼</h3>
                <p className="text-base leading-relaxed">
                  塔羅牌生命靈數系統揭示了每個人獨特的靈魂藍圖和人生使命，透過出生日期計算得出的大阿爾卡納牌，能深入理解個人的內在本質與外在表現。這套系統不僅是占卜工具，更是一份詳盡的自我成長地圖。每個人都擁有代表靈魂核心的「靈魂卡牌」和展現今生學習課題的「個性卡牌」，這兩張牌的互動關係描繪出個人從出生到死亡的生命主題。
                </p>
              </section>

              <section>
                 <h3 className="text-xl font-semibold text-purple-700 mb-2">理論架構與計算方法</h3>
                 <p className="text-base leading-relaxed mb-2">
                  此計算器採用 Mary K. Greer 的方法：將出生日期的所有數字相加，如果總和大於21，則繼續將結果的數字相加，直到小於或等於21為止。
                 </p>
                 <div className="bg-blue-50 rounded-lg p-4 text-sm text-blue-800">
                      <p className="font-semibold mb-1">計算範例：</p>
                      <ul className="list-disc list-inside space-y-1">
                        <li><b>靈魂卡牌</b>：將出生日期的每個數字相加（例：2000-08-05 → 2+0+0+0+0+8+0+5 = 15）。如果總和大於21（例：1992-02-21 → 26），持續將數字相加直到小於等於21（2+6 = 8）。</li>
                        <li><b>個性卡牌</b>：將靈魂卡牌的數字相加得到個性卡牌（如果靈魂卡牌已是個位數，則兩者相同）。</li>
                        <li><b>特殊組合</b>：當靈魂卡牌是19時，會產生三張牌：19 (太陽), 10 (命運之輪), 1 (魔術師)。其他兩位數靈魂卡牌(10-18, 20, 21)會產生靈魂牌、個性牌及陰影牌(靈魂牌 - 個性牌)。個位數靈魂牌(1-9)則靈魂牌與個性牌相同，無陰影牌。</li>
                      </ul>
                  </div>
              </section>

              <section>
                 <h3 className="text-xl font-semibold text-purple-700 mb-2">靈魂卡牌 vs. 個性卡牌 vs. 陰影/天賦卡牌</h3>
                 <div className="grid md:grid-cols-1 gap-4">
                      <div className="bg-purple-50 p-3 rounded-lg border-l-4 border-purple-500">
                          <h4 className="font-bold text-purple-800">靈魂卡牌 (Soul Card)</h4>
                          <p className="text-sm">代表個人的<b>靈魂目的</b>、<b>核心本質</b>與跨越多個生世的永恆特質。它反映靈魂的根本使命、與生俱來的天賦和最高潛能。</p>
                      </div>
                      <div className="bg-pink-50 p-3 rounded-lg border-l-4 border-pink-500">
                          <h4 className="font-bold text-pink-800">個性卡牌 (Personality Card)</h4>
                          <p className="text-sm">描述個人在<b>此生需要學習的課題</b>、外在世界的<b>人格表現方式</b>以及需要掌握和整合的人生功課。這是靈魂使命在現實生活中的體現。</p>
                      </div>
                      <div className="bg-slate-50 p-3 rounded-lg border-l-4 border-slate-500">
                          <h4 className="font-bold text-slate-800">陰影/天賦卡牌 (Shadow/Gift Card)</h4>
                          <p className="text-sm">此牌根據靈魂牌的特性而定：<br/>
                           - 若靈魂牌為兩位數(10-18, 20, 21)，此為<b>陰影牌</b> (靈魂牌-個性牌)，代表潛意識的挑戰、隱藏才能或需整合的課題。<br/>
                           - 若靈魂牌為19 (太陽)，此為<b>天賦牌</b> (個性牌的數字總和)，形成特殊的太陽三重創造循環 (19太陽 → 10命運之輪 → 1魔術師)。<br/>
                           - 若靈魂牌為個位數(1-9)，則無額外陰影/天賦牌，能量高度集中。
                          </p>
                      </div>
                 </div>
              </section>

              <section>
                  <h3 className="text-xl font-semibold text-purple-700 mb-2">生命牌卡組合的解讀重點</h3>
                  <div className="space-y-4">
                      <div className="p-4 bg-gray-50 rounded-lg">
                          <h4 className="font-bold text-gray-800">情況一：統一型 (1張主牌，靈魂牌=個性牌)</h4>
                          <p className="text-sm mt-1">當生日數字總和為 1-9 時，您的「靈魂牌」與「個性牌」是同一張牌。這代表您的內在本質與外在表現高度一致，人生課題非常專注和強烈。您的挑戰與天賦都集中在這張牌的能量中，需深度理解該牌的正負兩面，以達至其最高表達。</p>
                      </div>
                      <div className="p-4 bg-gray-50 rounded-lg">
                          <h4 className="font-bold text-gray-800">情況二：標準雙牌組 (2張主牌 + 1張陰影牌)</h4>
                          <p className="text-sm mt-1">當生日數字總和為 10-18、20 或 21 時，您會有兩張主要牌卡及一張陰影牌。陰影牌（靈魂牌 - 個性牌）揭示了靈魂與個性間的潛在張力、深層恐懼、未被發掘的才能或需要特別整合的人生課題。這三張牌共同構成您此生的學習藍圖，陰影牌的整合是成長的關鍵。</p>
                      </div>
                      <div className="p-4 bg-gray-50 rounded-lg">
                          <h4 className="font-bold text-gray-800">情況三：太陽特殊三重牌組 (3張主牌)</h4>
                          <p className="text-sm mt-1">當生日數字總和為 19 (太陽) 時，這是一個非常特殊的組合，形成一個創造循環：<b>19 (太陽)</b> → <b>10 (命運之輪)</b> → <b>1 (魔術師)</b>。這三張牌分別代表光輝的實現(太陽)、宇宙的機遇(命運之輪)和個人的意志與創造力(魔術師)，共同構成您強大的顯化潛能和生命活力。挑戰在於協調這三股強大能量，使其順暢流動。</p>
                      </div>
                  </div>
              </section>

              <section>
                <h3 className="text-xl font-semibold text-purple-700 mb-2">整合與實踐</h3>
                <p className="text-base leading-relaxed">
                  生命的前半段（約35歲前）主要發展個性卡牌的特質，學習在社會中建立身份。生命後半段則轉向靈魂卡牌的深度探索，尋求生命意義。理解您的生命牌卡不是限制，而是指引。透過認識自己的天賦與挑戰，每個人都能更好地實現潛能，在人生旅程中找到方向和意義。陰影牌或天賦牌的整合尤其重要，它們是通往更完整自我的鑰匙。
                </p>
              </section>
            </div>
          );
          
          const generateDetailedTarotReport = (cardSet) => {
              const { soulCard, personalityCard, shadowCard, giftCard } = cardSet;
              
              let introduction = '';
              let cardsAnalysis = [];
              let dynamicsAnalysis = '';
              let developmentalFocus = '';
              
              const getCardName = (id) => cardDetails[id]?.name || '未知卡牌';
              const getCardChallenges = (id) => cardDetails[id]?.challenges || '請參閱卡牌詳細說明。';

              if (giftCard !== null) { // 太陽特殊三重牌組 (19)
                  introduction = `您的生命牌卡組合是極其罕見且強大的「太陽三重奏」：${getCardName(soulCard)}(${soulCard}) → ${getCardName(personalityCard)}(${personalityCard}) → ${getCardName(giftCard)}(${giftCard})。這是一個動態的創造循環，象徵您天生擁有將夢想轉化為現實的非凡能力，是宇宙能量的顯化通道。`;
                  cardsAnalysis = [
                      { cardId: soulCard, role: '主題牌：太陽 - 光輝實現與生命喜悅', roleKey: 'soul' },
                      { cardId: personalityCard, role: '過程牌：命運之輪 - 把握宇宙時機與資源流動', roleKey: 'personality' },
                      { cardId: giftCard, role: '動力牌：魔術師 - 個人意志與創造力的主動運用', roleKey: 'gift' }
                  ];
                  dynamicsAnalysis = `在您的太陽三重奏中，${getCardName(giftCard)} (${giftCard})是「點火器」，代表您個人意志和創造衝動的源頭；${getCardName(personalityCard)} (${personalityCard})是「放大器」與「催化劑」，為您接引宇宙的機遇和資源；${getCardName(soulCard)} (${soulCard})是「展現台」，將您的創造成果以最光輝的形式展現給世界。這個循環是 1 → 10 → 19 (1+0=1 魔術師的意志 → 10 命運之輪的機遇 → 19 太陽的成果)。`;
                  developmentalFocus = `此組合的挑戰在於有意識地協調這三股強大能量，讓它們形成一個和諧的創造循環，而非各自為政或過度消耗。關鍵在於：\n1. ${getCardName(giftCard)}: 清晰您的意圖與目標 (${getCardChallenges(giftCard)})\n2. ${getCardName(personalityCard)}: 信任宇宙的安排並順應變化 (${getCardChallenges(personalityCard)})\n3. ${getCardName(soulCard)}: 樂觀自信地展現成果並分享喜悅 (${getCardChallenges(soulCard)})。避免因能量過強而忽略過程中的細節與他人的感受。`;
              } else if (shadowCard === null) { // 統一型 (1-9)
                  introduction = `您是極其特殊的「統一型」人格 - 靈魂牌與個性牌均為 ${soulCard} 號「${getCardName(soulCard)}」。這意味著您的內在本質與外在表現高度統一，人生課題異常集中和強烈。您此生的所有學習、挑戰與天賦都聚焦在這一張牌的深層奧義中。`;
                  cardsAnalysis = [{ cardId: soulCard, role: '核心原型：您的存在本質與表達方式', roleKey: 'soul' }];
                  dynamicsAnalysis = `作為統一型，您的內外能量完全集中在 ${getCardName(soulCard)} 的原型上。這賦予您巨大的專注力和潛能，但也可能讓您更容易陷入該牌的極端表現或盲點中。`;
                  developmentalFocus = `您的成長關鍵在於對 ${getCardName(soulCard)} 的能量進行深度覺察，有意識地平衡其天賦與挑戰面。請特別關注 ${getCardName(soulCard)} 的挑戰：${getCardChallenges(soulCard)}。學會駕馭此原型能量，既體現其所有光明面，又能整合其陰影，以達到該原型的最高表達，避免其負面特質過度顯現。`;
              } else { // 標準雙牌組 + 陰影牌 (10-18, 20, 21)
                  introduction = `您的生命牌卡構成一個完整的三維學習藍圖：靈魂牌「${getCardName(soulCard)}」(${soulCard})定義了您的核心使命和最高潛能；個性牌「${getCardName(personalityCard)}」(${personalityCard})是您今生需要掌握的主要課題和外在表達方式；而陰影牌「${getCardName(shadowCard)}」(${shadowCard})則揭示了前兩張牌之間的潛在張力、您需要整合的深層挑戰與隱藏力量。`;
                  cardsAnalysis = [
                      { cardId: soulCard, role: '靈魂牌：您永恆的本質與最高使命', roleKey: 'soul' },
                      { cardId: personalityCard, role: '個性牌：您今生的學習課題與展現', roleKey: 'personality' },
                      { cardId: shadowCard, role: '陰影牌：需要整合的內在動力與挑戰', roleKey: 'shadow' }
                  ];
                  dynamicsAnalysis = `您的生命藍圖中，${getCardName(personalityCard)} (${personalityCard}) 是您實踐 ${getCardName(soulCard)} (${soulCard}) 使命的主要途徑。然而，${getCardName(shadowCard)} (${shadowCard}) 代表了在這個過程中可能出現的內在衝突、恐懼或未被看見的潛能。它既是挑戰，也是整合靈魂與個性的關鍵橋樑。`;
                  developmentalFocus = `核心課題在於有意識地覺察並整合 ${getCardName(shadowCard)} 所代表的能量。其挑戰為：${getCardChallenges(shadowCard)}。\n當您試圖用 ${getCardName(personalityCard)} 的特質（挑戰：${getCardChallenges(personalityCard)}）去過度補償或逃避 ${getCardName(shadowCard)} 的課題時，能量易失衡。\n反之，若能擁抱並轉化 ${getCardName(shadowCard)} 的陰影面，您的靈魂使命（${getCardName(soulCard)}，挑戰：${getCardChallenges(soulCard)}）將更自然、強大地透過您的個性表達出來。這個整合過程是您此生持續的功課。`;
              }
              return { introduction, cardsAnalysis, dynamicsAnalysis, developmentalFocus, cardSet };
          };

          const calculateTarotCards = (date) => {
            const digits = date.replace(/-/g, '').split('').map(Number);
            let total = digits.reduce((sum, digit) => sum + digit, 0);
            const steps = [`出生年月日數字相加: ${digits.join(' + ')} = ${total}`];
            while (total > 21) {
              const newDigits = total.toString().split('').map(Number);
              const newTotal = newDigits.reduce((sum, digit) => sum + digit, 0);
              steps.push(`總和 > 21，繼續相加: ${newDigits.join(' + ')} = ${newTotal}`);
              total = newTotal;
            }
            const soulCard = total;
            let personalityCard = null;
            let shadowCard = null;
            let giftCard = null;
            const getCardName = (id) => cardDetails[id]?.name || '未知卡牌';
            if (soulCard >= 10) {
              const personalityDigits = soulCard.toString().split('').map(Number);
              personalityCard = personalityDigits.reduce((sum, digit) => sum + digit, 0);
              if (soulCard === 19) {
                giftCard = personalityCard.toString().split('').map(Number).reduce((s,d)=>s+d,0); 
                steps.push(`靈魂卡牌為 19 (${getCardName(19)})，形成特殊太陽三重牌組。`);
                steps.push(`個性/過程牌: 1 + 9 = ${personalityCard} (${getCardName(personalityCard)})`);
                steps.push(`天賦/動力牌: 1 + 0 = ${giftCard} (${getCardName(giftCard)})`);
              } else {
                personalityCard = soulCard.toString().split('').map(Number).reduce((sum, digit) => sum + digit, 0);
                shadowCard = soulCard - personalityCard;
                steps.push(`靈魂卡牌為 ${soulCard} (${getCardName(soulCard)})。`);
                steps.push(`個性卡牌: ${soulCard.toString().split('').join(' + ')} = ${personalityCard} (${getCardName(personalityCard)})`);
                steps.push(`陰影牌: ${soulCard} - ${personalityCard} = ${shadowCard} (${getCardName(shadowCard)})`);
              }
            } else {
              personalityCard = soulCard;
              steps.push(`靈魂卡牌為個位數 ${soulCard} (${getCardName(soulCard)})。`);
              steps.push(`個性卡牌與其相同: ${personalityCard} (${getCardName(personalityCard)})。`);
              steps.push(`此為統一型，無額外陰影牌或天賦牌。`);
            }
            return { soulCard, personalityCard, shadowCard, giftCard, steps };
          };

          const handleCalculate = () => {
            if (!birthDate) {
              alert('請輸入出生日期');
              return;
            }
            const cardSet = calculateTarotCards(birthDate);
            setResult(cardSet);
            const report = generateDetailedTarotReport(cardSet);
            setDetailedReport(report);
            setShowProcess(false);
            setViewMode('simple'); 
          };

          const formatDate = (date) => {
            if (!date) return '';
            const parts = date.split('-');
            return `${parts[0]}年${parts[1]}月${parts[2]}日`;
          };

          const CardDisplay = ({ icon, title, cardId, bgColor, textColor, borderColor, type, description, challenges }) => {
            if (cardId === null || cardId === undefined || !cardDetails[cardId]) return null;
            const details = cardDetails[cardId];
            let displayDescription = description;
            if (type === 'soul') displayDescription = details.soulMission;
            else if (type === 'personality') displayDescription = details.personalityTrait;
            return (
              <div className={`${bgColor} rounded-lg p-4 shadow-sm md:shadow-md border-l-4 ${borderColor} transition-all duration-300`}>
                {/* Card Image */}
                <div className="relative mb-3">
                  <img 
                    src={sharedGetCardImagePath(cardId)} 
                    alt={details.name}
                    className="w-full max-w-[150px] mx-auto rounded-lg shadow-md object-cover border-2 border-white"
                    onError={(e) => e.target.style.display = 'none'}
                  />
                </div>
                
                <div className="flex items-center gap-2 mb-2">{icon}<h3 className={`font-semibold ${textColor}`}>{title}</h3></div>
                <div className={`text-2xl font-bold ${textColor} mb-1`}>{cardId} - {details.name}</div>
                <p className={`text-sm font-semibold ${textColor} mb-2`}>{details.shortMeaning}</p>
                <p className={`text-xs ${textColor} opacity-80 mb-2`}>{displayDescription}</p>
                {challenges && (<p className={`text-xs ${textColor} opacity-70 mt-1`}><span className="font-semibold">挑戰：</span>{challenges}</p>)}
              </div>
            );
          };
          
          const DetailedTarotReport = ({ reportData }) => {
            const [openSections, setOpenSections] = useState({});
            const [expandedAnalysis, setExpandedAnalysis] = useState(true);
            const toggleSection = (id) => setOpenSections(prev => ({...prev, [id]: !prev[id]}));

            if (!reportData || !reportData.cardsAnalysis) return <p>報告生成中...</p>;

            return (
                <div className="bg-white rounded-lg p-6 shadow-lg mt-6 animate-fade-in">
                    <h2 className="text-3xl font-bold text-purple-900 mb-3 text-center">您的深度塔羅生命藍圖報告</h2>
                    <p className="text-center text-gray-700 mb-6 text-base leading-relaxed">{reportData.introduction}</p>
                    
                    <div className="space-y-6 mb-8">
                        <h3 className="text-2xl font-bold text-purple-800 text-center mb-4">核心原型卡牌解析</h3>
                        {reportData.cardsAnalysis.map((cardAnalysis, index) => {
                            const cardData = cardDetails[cardAnalysis.cardId];
                            if (!cardData) return null; 
                            const sectionId = `card-${cardAnalysis.cardId}-${index}`;
                            return (
                                <div key={index} className="border-2 border-purple-200 rounded-lg overflow-hidden shadow-md">
                                    <button onClick={() => toggleSection(sectionId)} className="w-full p-5 bg-gradient-to-r from-purple-100 to-pink-100 hover:from-purple-200 hover:to-pink-200 flex justify-between items-center transition-all duration-300">
                                        <div className="text-left">
                                            <span className="text-lg sm:text-xl font-bold text-purple-800">{cardAnalysis.role}: {cardData.name} ({cardAnalysis.cardId})</span>
                                            <div className="text-sm text-purple-600 mt-1">核心意義: {cardData.shortMeaning || ''}</div>
                                        </div>
                                        <span className="text-purple-600 text-2xl">{openSections[sectionId] ? <ChevronUp /> : <ChevronDown />}</span>
                                    </button>
                                    {openSections[sectionId] && (
                                        <div className="p-6 bg-white space-y-4 animate-fade-in">
                                            <div className="p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
                                                <h4 className="font-bold text-green-800 mb-2 flex items-center gap-1"><Sparkles className="w-4 h-4" /> 天賦與靈魂使命 ({cardAnalysis.roleKey === 'gift' ? '此牌在此組合中的天賦展現' : '核心天賦'})</h4>
                                                <p className="text-sm text-gray-700 leading-relaxed">{cardData.soulMission}</p>
                                            </div>
                                            <div className="p-4 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                                                <h4 className="font-bold text-orange-800 mb-2 flex items-center gap-1"><User className="w-4 h-4" /> 人格特質與今生表現 ({cardAnalysis.roleKey === 'gift' ? '此牌在此組合中的行為模式' : '主要特質'})</h4>
                                                <p className="text-sm text-gray-700 leading-relaxed">{cardData.personalityTrait}</p>
                                            </div>
                                            <div className="p-4 bg-red-50 rounded-lg border-l-4 border-red-500">
                                                <h4 className="font-bold text-red-800 mb-2 flex items-center gap-1"><AlertCircleIcon className="w-4 h-4" /> 主要挑戰與成長課題 ({cardAnalysis.roleKey === 'gift' ? '此牌在此組合中的挑戰' : '核心挑戰'})</h4>
                                                <p className="text-sm text-gray-700 leading-relaxed">{cardData.challenges}</p>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>

                     <div className="mb-8">
                        <button onClick={() => setExpandedAnalysis(!expandedAnalysis)} className="w-full p-5 bg-gradient-to-r from-blue-100 to-indigo-100 hover:from-blue-200 hover:to-indigo-200 rounded-lg shadow-md transition-all duration-300 flex items-center justify-between">
                            <h3 className="text-xl sm:text-2xl font-bold text-blue-900 flex items-center gap-2"><BrainIcon /> 牌組互動動力學分析</h3>
                            <span className="text-blue-600 text-2xl">{expandedAnalysis ? <ChevronUp /> : <ChevronDown />}</span>
                        </button>
                        {expandedAnalysis && (
                            <div className="mt-4 p-6 bg-blue-50 rounded-lg border-2 border-blue-200 animate-fade-in">
                                <h4 className="font-bold text-blue-800 mb-2 text-lg">內在能量流動：</h4>
                                <p className="text-blue-900 leading-relaxed text-sm whitespace-pre-line mb-4">{reportData.dynamicsAnalysis}</p>
                                <h4 className="font-bold text-red-700 mb-2 text-lg">發展焦點與挑戰整合：</h4>
                                <p className="text-red-800 leading-relaxed text-sm whitespace-pre-line bg-red-50 p-3 rounded">{reportData.developmentalFocus}</p>
                            </div>
                        )}
                    </div>
                    
                    <div className="text-center p-6 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border border-purple-200">
                        <h4 className="text-xl font-bold text-purple-800 mb-3">🙏 整合與實踐</h4>
                        <p className="text-gray-700 leading-relaxed text-sm">這份報告提供了一個關於您生命藍圖的深度視角。請記住，這些牌卡不是對您的限制，而是一份珍貴的指引。它們揭示了您的天賦、挑戰與最高的潛能。通过理解和整合這些原型能量，特別是覺察並轉化報告中提及的挑戰與發展焦點，您將能更有意識地走在屬於自己的獨特生命道路上，活出最真實、最完整的自己。</p>
                    </div>
                </div>
            );
          };


          return (
            <div className="max-w-3xl mx-auto p-4 sm:p-6 bg-gradient-to-br from-purple-100 to-pink-100 rounded-xl shadow-lg md:shadow-xl font-sans">
              <div className="text-center mb-8">
                <h1 className="text-3xl font-bold text-purple-800 mb-2 flex items-center justify-center gap-2"><Sparkles className="w-8 h-8" />塔羅生命靈數計算器</h1>
                <p className="text-gray-600">依據 Mary K. Greer 系統，解碼您的主牌、個性牌與陰影/天賦牌</p>
              </div>
              <div className="bg-white rounded-lg p-6 shadow-md mb-6">
                <div className="mb-6"><label className="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2"><Calendar />請輸入您的出生日期</label><input type="date" value={birthDate} onChange={(e) => setBirthDate(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent"/></div>
                <button onClick={handleCalculate} className="w-full bg-purple-600 text-white py-3 rounded-md hover:bg-purple-700 transition-colors font-semibold flex items-center justify-center gap-2"><Sparkles className="w-5 h-5" /> 計算我的生命牌卡</button>
              </div>
              {result && (
                <div className="space-y-6 animate-fade-in">
                  <div className="bg-white rounded-lg p-4 shadow-md">
                    <div className="flex justify-center space-x-2 sm:space-x-4">
                      <button onClick={() => setViewMode('simple')} className={`px-4 py-2 sm:px-6 sm:py-3 rounded-lg font-semibold transition-all text-sm sm:text-base ${viewMode === 'simple' ? 'bg-purple-600 text-white shadow-lg transform scale-105' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>📊 簡要概覽</button>
                      <button onClick={() => setViewMode('detailed')} className={`px-4 py-2 sm:px-6 sm:py-3 rounded-lg font-semibold transition-all text-sm sm:text-base ${viewMode === 'detailed' ? 'bg-purple-600 text-white shadow-lg transform scale-105' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>📚 詳細分析</button>
                    </div>
                  </div>
                  {viewMode === 'simple' ? (
                    <div className="bg-white rounded-lg p-6 shadow-md">
                      <h2 className="text-xl font-bold text-gray-800 mb-4">您的塔羅生命靈數結果 ({formatDate(birthDate)})</h2>
                      <div className="grid md:grid-cols-1 gap-6">
                        <CardDisplay icon={<Hash className="w-5 h-5 text-purple-600" />} title="靈魂卡牌 (Soul Card)" cardId={result.soulCard} bgColor="bg-purple-100" textColor="text-purple-900" borderColor="border-purple-500" type="soul" challenges={cardDetails[result.soulCard]?.challenges}/>
                        <CardDisplay icon={<User className="w-5 h-5 text-pink-600" />} title="個性卡牌 (Personality Card)" cardId={result.personalityCard} bgColor="bg-pink-100" textColor="text-pink-900" borderColor="border-pink-500" type="personality" challenges={cardDetails[result.personalityCard]?.challenges}/>
                        {result.shadowCard !== null && cardDetails[result.shadowCard] && (<CardDisplay icon={<Shield className="w-5 h-5 text-slate-600" />} title="陰影牌 (Shadow Card)" cardId={result.shadowCard} bgColor="bg-slate-100" textColor="text-slate-900" borderColor="border-slate-500" description="這是您需要面對與整合的內在挑戰，也是隱藏的潛能所在。" challenges={cardDetails[result.shadowCard]?.challenges}/>)}
                        {result.giftCard !== null && cardDetails[result.giftCard] && (<CardDisplay icon={<Gift className="w-5 h-5 text-yellow-600" />} title="隱藏/天賦卡牌 (Hidden/Gift Card)" cardId={result.giftCard} bgColor="bg-yellow-100" textColor="text-yellow-900" borderColor="border-yellow-500" description="作為太陽三重奏的一部分，這代表您的核心意志與天賦才能。" challenges={cardDetails[result.giftCard]?.challenges}/>)}
                      </div>
                      <button onClick={() => setShowProcess(!showProcess)} className="mt-6 text-purple-600 hover:text-purple-800 text-sm font-medium flex items-center gap-1">{showProcess ? '隱藏' : '顯示'}計算過程<span className="text-purple-600">{showProcess ? <ChevronUp /> : <ChevronDown />}</span></button>
                      {showProcess && (<div className="mt-4 p-4 bg-gray-50 rounded-lg animate-fade-in"><h4 className="font-semibold text-gray-700 mb-2">計算步驟：</h4><p className="text-sm text-gray-600 mb-2">出生日期：{formatDate(birthDate)}</p><div className="space-y-1">{result.steps.map((step, index) => (<p key={index} className="text-sm font-mono text-gray-700">{step}</p>))}</div></div>)}
                    </div>
                  ) : (detailedReport && <DetailedTarotReport reportData={detailedReport} />)}
                </div>
              )}
              <div className="text-center mt-8">
                <button onClick={() => setShowInfo(!showInfo)} className="inline-flex items-center gap-2 px-6 py-3 bg-white text-purple-700 rounded-full shadow-md hover:bg-purple-50 transition-transform transform hover:scale-105"><span className="font-semibold">了解更多關於塔羅生命靈數</span>{showInfo ? <ChevronUp className="w-5 h-5" /> : <ChevronDown className="w-5 h-5" />}</button>
              </div>
              {showInfo && <TarotTheoryInfo />}
            </div>
          );
        };
        
        // --- TAROT COMPATIBILITY SYSTEM ---
        const TarotCompatibilitySystem = () => {
          const [person1Date, setPerson1Date] = useState('');
          const [person2Date, setPerson2Date] = useState('');
          const [person1Name, setPerson1Name] = useState('夥伴 A');
          const [person2Name, setPerson2Name] = useState('夥伴 B');
          const [result, setResult] = useState(null);
          const [showDetails, setShowDetails] = useState({ soul: false, personality: false, shadow: false, yearly: false, monthly: false });
          
          const [targetYear, setTargetYear] = useState(new Date().getFullYear());
          const [targetMonth, setTargetMonth] = useState(new Date().getMonth() + 1);
          
          const baseCompatibilityMatrix = {
             0: { 1: { score: 90, type: '無限潛能的啟動者', desc: '愚者的無限潛能與魔術師的實現能力相結合，創造出一段充滿驚喜與顯化奇蹟的關係。魔術師能夠捕捉愚者天馬行空的想法，並將其具體化，而愚者則能為魔術師帶來全新的視角和冒險的勇氣。', challenges: '愚者的隨性可能讓目標導向的魔術師感到挫敗，而魔術師的掌控欲可能限制了愚者的自由。需要學習在自發性與計劃性之間找到平衡，共同享受旅程而非僅僅專注於結果。' } },
             1: { 1: { score: 85, type: '雙重意志力', desc: '兩個1號魔術師相遇，代表著意志力、創造力和行動力的強強結合。這是一段充滿活力和創新潛能的關係，雙方都擁有將想法化為現實的強大能力，能夠共同發起並推動項目，快速取得進展。', challenges: '主要的挑戰在於「誰來主導？」。兩個強勢的個體可能產生權力鬥爭或競爭。需要有意識地協調目標，避免自我中心，並學會輪流領導或共同合作。如果溝通不良或缺乏共同願景，強大的能量可能會轉向內部衝突，而非外部創造。' }, 2: { score: 75, type: '行動與直覺', desc: '魔術師的行動力與女祭司的直覺洞察形成互補。魔術師能將女祭司的深層智慧化為實際行動，而女祭司則能為魔術師提供方向與深度。', challenges: '魔術師可能覺得女祭司過於被動或神秘，女祭司可能覺得魔術師太急躁或表面。需要耐心溝通，魔術師學習聆聽，女祭司學習表達。' }, 3: { score: 80, type: '創造與豐盛', desc: '魔術師的創造意志與女帝的豐饒能量結合，能共同創造出實質且美好的成果。魔術師提供方法，女帝提供滋養與資源。', challenges: '魔術師的目標導向可能與女帝的享受過程產生衝突。需平衡效率與享受，並確保創造的目標是雙方都認同的。' }, 4: { score: 70, type: '意志與結構', desc: '魔術師的創新能力與皇帝的組織結構相輔相成。魔術師帶來新點子，皇帝則能將其實現並制度化，建立穩固的基礎。', challenges: '魔術師可能覺得皇帝過於僵化，皇帝可能覺得魔術師不切實際。需要互相尊重對方的方法，魔術師學習務實，皇帝學習彈性。' }, 5: { score: 65, type: '創新與傳統', desc: '魔術師的個體創造力與教皇的傳統智慧形成有趣的對話。魔術師挑戰現狀，教皇提供經驗與道德框架。', challenges: '可能在方法論和價值觀上產生分歧。魔術師需要尊重智慧傳承，教皇需要對新方法保持開放，尋找融合點而非對立。' }, 6: {score:90,type:'創造性的愛',desc:'魔術師的創造力在戀人牌代表的愛與關係中能得到極大的滋養與發揮。他們共同做出選擇，創造充滿活力與和諧的關係，彼此激勵。', challenges:'魔術師的個人意志可能在關係選擇中過於強勢，或戀人牌的猶豫不決讓魔術師失去耐心。需要坦誠溝通各自的需求與價值觀，確保選擇是共同的。'}, 7: {score:85,type:'意志的推進力',desc:'魔術師的意志與戰車的決心結合，形成一股強大的前進動力。他們能共同設定目標並勇往直前，克服障礙，取得成功。', challenges:'兩者都非常強勢，若方向不一致，很容易產生衝突或競爭。需要明確的共同目標，並學會協調步伐，避免一方拖垮另一方。'}, 8: {score:80,type:'意志與內力',desc:'魔術師的外在顯化能力與力量牌的內在堅韌相結合，能以一種平衡的方式達成目標。魔術師帶來方法，力量牌帶來耐心與慈悲。', challenges:'魔術師的急切可能與力量牌的徐緩產生摩擦。魔術師需學習內在力量的柔韌，力量牌需學習更主動地運用能力。'}, 9: {score:60,type:'行動與內省',desc:'魔術師的外向行動與隱士的內向反思形成鮮明對比，但也可能互補。隱士的智慧能指引魔術師的行動，魔術師能將隱士的洞見付諸實踐。', challenges:'生活節奏和溝通方式差異大。魔術師可能覺得隱士太孤僻，隱士可能覺得魔術師太喧囂。需要尊重彼此的空間與需求。'}, 10:{score:85,type:'創造機遇',desc:'魔術師的顯化能力與命運之輪的機遇完美結合。魔術師能主動創造並抓住命運之輪帶來的機會，共同駕馭生命的流動。', challenges:'魔術師可能試圖掌控命運之輪的不可預測性，而命運之輪的變化可能打亂魔術師的計劃。學習在變化中保持彈性與信任是關鍵。'}, 11:{score:70,type:'意志與公正',desc:'魔術師的行動力需要正義牌的清晰判斷與平衡。正義能確保魔術師的創造是基於公平和真理的。', challenges:'魔術師的靈活性可能與正義的原則性產生衝突。正義的嚴謹可能讓魔術師感到受限。需要找到原則與彈性的平衡點。'}, 12:{score:65,type:'行動與臣服',desc:'魔術師的主動創造與倒吊人的被動臣服形成強烈對比。倒吊人的新視角可以啟發魔術師，魔術師可以幫助倒吊人走出停滯。', challenges:'魔術師可能不理解倒吊人的「無為」，倒吊人可能抗拒魔術師的催促。學習在適當的時候行動，在適當的時候等待與反思。'}, 13:{score:75,type:'創造與轉化',desc:'魔術師的創造力與死神的轉化力量結合，能帶來深刻的改變與新生。他們能共同結束舊模式，開創新局面。', challenges:'魔術師可能害怕死神帶來的徹底改變，死神的直接可能讓魔術師感到失控。需要勇氣去面對結束，並信任之後的新生。'}, 14:{score:80,type:'顯化與調和',desc:'魔術師的顯化能力與節制牌的調和藝術能創造出平衡且持久的成果。他們善於整合不同元素，創造和諧。', challenges:'魔術師的專注目標可能與節制的尋求多方平衡有所不同。需要耐心協商，確保行動既有效率又具包容性。'}, 15:{score:70,type:'意志與慾望',desc:'魔術師的意志力與惡魔牌的原始慾望相遇，可能爆發強大的創造力，也可能陷入束縛。關鍵在於如何引導這股能量。', challenges:'惡魔的誘惑可能讓魔術師誤用能力，或雙方陷入不健康的依賴。需要高度的自我覺察，將激情導向正面，避免沉溺。'}, 16:{score:75,type:'創造性突破',desc:'魔術師的創造力與塔的顛覆性能量結合，能帶來革命性的突破和舊有結構的瓦解，為新事物騰出空間。', challenges:'塔的突變可能打亂魔術師的計劃，甚至摧毀其成果。魔術師需學會在混亂中保持彈性，並將危機視為重建的機會。'}, 17:{score:85,type:'顯化希望',desc:'魔術師的實現能力與星星的希望靈感相結合，能將美好的願景化為現實，為自己和他人帶來光明。', challenges:'星星的理想主義可能讓魔術師的實際操作遇到困難。需要平衡夢想與現實，將希望落實於具體行動。'}, 18:{score:70,type:'意識與潛意識',desc:'魔術師的清晰意識與月亮的模糊潛意識相遇，是一場探索內在迷霧的旅程。月亮的直覺能豐富魔術師的創造，魔術師的理性有助於釐清幻象。', challenges:'月亮的幻象和恐懼可能干擾魔術師的專注力。魔術師的邏輯可能難以理解月亮的非理性。需要信任直覺，同時保持分辨能力。'}, 19:{score:90,type:'光輝創造',desc:'魔術師的創造力在太陽的光明照耀下得以充分展現。他們能共同創造充滿喜悅、成功和活力的成果，散發正能量。', challenges:'兩者都可能比較自我中心。魔術師需要確保其創造服務於太陽的整體福祉，太陽的強光不要灼傷魔術師的個別性。'}, 20:{score:80,type:'意志的覺醒',desc:'魔術師的顯化能力與審判的覺醒召喚結合，能共同響應生命的更高目的，實現深刻的轉化和人生目標的重新定義。', challenges:'審判的自我評估可能讓魔術師對過去的創造產生懷疑。魔術師需要將其能力導向新的、更有意義的方向，而非執著舊有。'}, 21:{score:85,type:'完成的創造',desc:'魔術師的創造力與世界的圓滿達成相輔相成。他們能將理念完美地實現，體驗到成就感和宇宙的合一。', challenges:'世界牌的完成感可能讓魔術師感到下一步無事可做。需要理解完成也是新循環的開始，魔術師的創造力永無止境。'}},
             2: { 2: { score: 85, type: '深層靈魂連結', desc: '兩位女祭司相遇，代表直覺、潛意識智慧與內在世界的深度共鳴。這是一段充滿神秘感、相互理解且無需過多言語的連結。她們能共同探索靈性奧秘，分享深邃的洞見。', challenges: '關係可能過於內向、被動，缺乏在現實世界的具體行動。雙方都可能壓抑情感，不願直接溝通。需要鼓勵彼此將內在智慧表達出來，並積極參與外部世界，避免陷入孤立或過度沉思。' }, 3: { score: 80, type: '直覺滋養創造', desc: '女祭司的直覺智慧與女帝的豐盛創造力形成強大的陰性力量結合。女祭司提供靈感與方向，女帝則將其實現並滋養，共同創造充滿愛與美的成果。', challenges: '女祭司的靜默可能與女帝的熱情外放產生步調不一。女帝可能覺得女祭司不夠投入物質層面，女祭司可能覺得女帝不夠深刻。需欣賞彼此的貢獻，找到內外平衡。' }, }
          };

          const fullCompatibilityMatrix = useMemo(() => {
                const matrix = JSON.parse(JSON.stringify(baseCompatibilityMatrix));
                for (let i = 0; i <= 21; i++) {
                    if (!matrix[i]) matrix[i] = {};
                    for (let j = i; j <= 21; j++) {
                        // Ensure inner object exists
                        if (!matrix[j]) matrix[j] = {};
                        // Check both [i][j] and [j][i]
                        if (!matrix[i][j] && !matrix[j][i]) {
                             const card1 = cardDetails[i];
                             const card2 = cardDetails[j];
                             if (!card1 || !card2) continue;

                             if (i === j) { // Self-pairing
                                matrix[i][j] = {
                                  score: 80, 
                                  type: `同頻共振 (${card1.name})`, 
                                  desc: `兩個 ${card1.name} 相遇，關於「${card1.shortMeaning}」的能量會被雙倍放大。這帶來深刻的理解與共鳴，能迅速建立連結，但也可能讓雙方共同的盲點被忽視。`, 
                                  challenges: `主要挑戰在於需要有意識地覺察並平衡 ${card1.name} 能量的極端表現。例如，雙方都可能陷入「${card1.challenges}」的困境中，缺乏另一種視角來打破僵局。`
                                };
                            } else { // Generic pairing
                                matrix[i][j] = {
                                  score: 70, 
                                  type: `互補學習 (${card1.name} & ${card2.name})`, 
                                  desc: `${card1.name} 所代表的「${card1.shortMeaning.split('、')[0]}」能量，與 ${card2.name} 的「${card2.shortMeaning.split('、')[0]}」主題相遇，創造了寶貴的學習與成長機會。一方的優點可以彌補另一方的不足。`, 
                                  challenges: `雙方需要理解並尊重彼此本質上的差異。${card1.name}的潛在挑戰 (${card1.challenges.split('。')[0]}) 可能與 ${card2.name} 的挑戰 (${card2.challenges.split('。')[0]}) 相互作用，需要耐心地溝通和磨合。`
                                };
                            }
                        }
                    }
                }
                return matrix;
          }, []);

          const getCardName = (id) => cardDetails[id]?.name || '未知卡牌';

          const calculatePersonTarotCards = (date) => {
            const digits = date.replace(/-/g, '').split('').map(Number);
            let total = digits.reduce((sum, digit) => sum + digit, 0);
            while (total > 21) {
              const newDigits = total.toString().split('').map(Number);
              total = newDigits.reduce((sum, digit) => sum + digit, 0);
            }
            const soulCard = total;
            let personalityCard;
            if (soulCard < 10) { 
                personalityCard = soulCard;
            } else {
              const personalityDigits = soulCard.toString().split('').map(Number);
              personalityCard = personalityDigits.reduce((sum, digit) => sum + digit, 0);
            }
            
            // This is a specific compatibility calculation, different from the individual one. 
            // 22-soul card reveals a complementary or challenging energy.
            const soulValueForShadow = soulCard === 0 ? 22 : soulCard;
            let compShadowCard = 22 - soulValueForShadow;
            
            return { soulCard, personalityCard, shadowCard: compShadowCard };
          };

          const getCompatibility = (card1, card2) => {
            if (card1 === null || card2 === null) return { score: 0, type: '資訊不足', desc: '無法計算，因為缺少一方或雙方的牌卡資訊。', challenges: '' };
            
            let c1 = card1, c2 = card2;
            if (c1 > c2) [c1, c2] = [c2, c1]; // Ensure c1 is always smaller for matrix lookup

            if (fullCompatibilityMatrix[c1] && fullCompatibilityMatrix[c1][c2]) {
              return fullCompatibilityMatrix[c1][c2];
            }
            if (fullCompatibilityMatrix[c2] && fullCompatibilityMatrix[c2][c1]) { // Fallback check
                return fullCompatibilityMatrix[c2][c1];
            }
            
            // Should be covered by the generic generator, but as a final fallback:
            return { score: 50, type: '中性關係', desc: '這是一段充滿未知與探索空間的關係。', challenges: '缺乏天然的強烈共鳴或明顯的互補性，需要更多有意識的溝通來建立深層連結。' };
          };

          const getOverallCompatibility = (soulComp, personalityComp, shadowComp) => {
            if (!soulComp || !personalityComp || !shadowComp) return { avgScore: 0, level: '無法評估', advice: '數據不足，無法生成綜合建議。'};
            // Weighting: soul 40%, personality 40%, shadow 20%
            const avgScore = (soulComp.score * 0.4) + (personalityComp.score * 0.4) + (shadowComp.score * 0.2);
            let level, advice;
            if (avgScore >= 85) { level = '🌟🌟🌟🌟🌟 靈魂高度共鳴'; advice = '你們在多個層面有著深刻的靈魂連結和高度契合，彼此能夠深度理解、支持與啟發。這是一段具有巨大共同進化潛力的關係，共同探索生命的奧秘。'; }
            else if (avgScore >= 75) { level = '🌟🌟🌟🌟 高度心靈契合'; advice = '你們在核心價值與生命目標上有良好的共鳴，個性上也能相互欣賞。透過坦誠溝通與共同學習，可以達到更深的親密與理解，是一段能帶來喜悅與成長的關係。'; }
            else if (avgScore >= 65) { level = '🌟🌟🌟 互補成長夥伴'; advice = '你們的差異可以成為彼此成長的催化劑和學習的鏡子。關係中可能存在一些挑戰，但只要保持開放、尊重與理解，就能將差異轉化為互補的優勢，共同進步。'; }
            else if (avgScore >= 55) { level = '🌟🌟 學習型挑戰關係'; advice = '這段關係中，挑戰與機遇並存。你們的相遇是為了學習重要的人生課題，可能需要更多的努力、耐心和有意識的溝通來化解摩擦。若能共同克服，將帶來深刻的個人成長。'; }
            else { level = '🌟 深層課題探索'; advice = '你們的連結觸及了較深的生命課題或過往模式。關係可能感覺複雜，需要極大的耐心、慈悲和自我反思。這是一段潛力巨大的靈魂功課，重點在於自我覺察與轉化，而非僅僅是關係的和諧。'; }
            return { avgScore: Math.round(avgScore), level, advice };
          };

          const handleAnalyze = () => {
            if (!person1Date || !person2Date) { alert('請填寫兩位夥伴的出生日期'); return; }
            if (!person1Name || !person2Name) { alert('請填寫兩位夥伴的姓名/暱稱'); return; }
            
            const person1Cards = calculatePersonTarotCards(person1Date);
            const person2Cards = calculatePersonTarotCards(person2Date);
            
            const person1FortuneCards = sharedCalculateFortuneCards(person1Date, targetYear, targetMonth);
            const person2FortuneCards = sharedCalculateFortuneCards(person2Date, targetYear, targetMonth);
            
            const soulCompatibility = getCompatibility(person1Cards.soulCard, person2Cards.soulCard);
            const personalityCompatibility = getCompatibility(person1Cards.personalityCard, person2Cards.personalityCard);
            const shadowCompatibility = getCompatibility(person1Cards.shadowCard, person2Cards.shadowCard); 
            const overall = getOverallCompatibility(soulCompatibility, personalityCompatibility, shadowCompatibility);

            const yearlyCompatibility = getCompatibility(person1FortuneCards.yearlyCard, person2FortuneCards.yearlyCard);
            const monthlyCompatibility = getCompatibility(person1FortuneCards.monthlyCard, person2FortuneCards.monthlyCard);

            setResult({ 
                person1: { name: person1Name, ...person1Cards, fortuneCards: person1FortuneCards }, 
                person2: { name: person2Name, ...person2Cards, fortuneCards: person2FortuneCards }, 
                compatibility: { soul: soulCompatibility, personality: personalityCompatibility, shadow: shadowCompatibility, yearly: yearlyCompatibility, monthly: monthlyCompatibility, overall },
                timeframe: { year: targetYear, month: targetMonth }
            });
            setShowDetails({ soul: false, personality: false, shadow: false, yearly: false, monthly: false });
          };

          const getScoreColor = (score) => { if (score >= 85) return 'text-green-600'; if (score >= 75) return 'text-blue-600'; if (score >= 65) return 'text-yellow-600'; if (score >=55) return 'text-orange-600'; return 'text-red-600'; };
          const getScoreBg = (score) => { if (score >= 85) return 'bg-green-100'; if (score >= 75) return 'bg-blue-100'; if (score >= 65) return 'bg-yellow-100'; if (score >=55) return 'bg-orange-100'; return 'bg-red-100'; };
          
          const CompatibilityItem = ({ itemKey, title, icon, cards, compatibilityInfo, infoText, isOpen, onToggle }) => (
            <div className="bg-white rounded-lg p-4 sm:p-6 shadow-md">
              <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between cursor-pointer" onClick={onToggle}>
                <h3 className="font-semibold text-gray-800 flex items-center gap-2 mb-2 sm:mb-0 text-base sm:text-lg">{icon} {title}</h3>
                <div className="flex items-center gap-2 sm:gap-4 w-full sm:w-auto justify-end">
                    <span className={`text-xl sm:text-2xl font-bold ${getScoreColor(compatibilityInfo.score)}`}>{compatibilityInfo.score}%</span>
                    <span className={`px-2 py-1 sm:px-3 rounded-full text-xs sm:text-sm font-medium whitespace-nowrap ${getScoreBg(compatibilityInfo.score)} ${getScoreColor(compatibilityInfo.score)}`}>{compatibilityInfo.type}</span>
                    <span className="text-purple-600 text-xl">{isOpen ? <ChevronUp /> : <ChevronDown />}</span>
                </div>
              </div>
              {isOpen && (<div className="mt-4 pt-4 border-t animate-fade-in text-sm">
                  <div className="mb-3 p-3 bg-gray-50 rounded-md">
                    <p className="font-semibold text-gray-700">互動牌組：</p>
                    
                    {/* Partner Card Images */}
                    <div className="flex justify-center gap-4 my-3">
                      <div className="text-center">
                        <img 
                          src={sharedGetCardImagePath(cards[0])} 
                          alt={getCardName(cards[0])}
                          className="w-16 h-24 object-cover rounded-md shadow-md border-2 border-white mx-auto"
                        />
                        <p className="text-xs mt-1">{getCardName(cards[0])}</p>
                      </div>
                      <HeartIcon className="text-red-500 text-2xl self-center" />
                      <div className="text-center">
                        <img 
                          src={sharedGetCardImagePath(cards[1])} 
                          alt={getCardName(cards[1])}
                          className="w-16 h-24 object-cover rounded-md shadow-md border-2 border-white mx-auto"
                        />
                        <p className="text-xs mt-1">{getCardName(cards[1])}</p>
                      </div>
                    </div>
                    
                    <p className="text-gray-600"> {getCardName(cards[0])} ({cards[0]}) <HeartIcon className="inline text-red-500 mx-1" /> {getCardName(cards[1])} ({cards[1]})</p>
                  </div>
                  <h5 className="font-semibold text-gray-700 mb-1">能量互動描述：</h5><p className="text-gray-600 mb-3 leading-relaxed">{compatibilityInfo.desc}</p>
                  <h5 className="font-semibold text-red-700 mb-1 flex items-center gap-1"><AlertCircleIcon className="w-4 h-4" /> 潛在挑戰與成長點：</h5><p className="text-red-600 bg-red-50 p-3 rounded-md mb-3 leading-relaxed">{compatibilityInfo.challenges || "共同探索與理解是關鍵。"}</p>
                  {infoText && (<div className="mt-3 p-3 bg-indigo-50 rounded-lg border-l-4 border-indigo-400"><p className="text-sm text-indigo-700 flex items-start"><InfoIcon className="w-4 h-4 inline mr-2 mt-0.5 flex-shrink-0" /><span>{infoText}</span></p></div>)}
              </div>)}
            </div>
          );


          return (
            <div className="max-w-4xl mx-auto p-4 sm:p-6 bg-gradient-to-br from-purple-100 via-pink-100 to-indigo-100 rounded-xl shadow-xl font-sans">
              <div className="text-center mb-8"><h1 className="text-3xl font-bold text-purple-800 mb-2 flex items-center justify-center gap-2"><HeartIcon className="w-8 h-8" />塔羅牌雙人兼容性深度分析</h1><p className="text-gray-600">依據塔羅原型互動，深入分析兩人的靈魂契合度、個性相容性與共同成長潛力</p></div>
              
              <div className="bg-white rounded-lg p-6 shadow-md mb-6">
                <div className="grid md:grid-cols-2 gap-x-6 gap-y-8">
                    <div className="space-y-4">
                        <h3 className="font-semibold text-gray-800 flex items-center gap-2"><UsersIcon className="w-5 h-5" /> 第一位夥伴</h3>
                        <input type="text" placeholder="姓名/暱稱" value={person1Name} onChange={(e) => setPerson1Name(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500"/>
                        <input type="date" value={person1Date} onChange={(e) => setPerson1Date(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500"/>
                    </div>
                    <div className="space-y-4">
                        <h3 className="font-semibold text-gray-800 flex items-center gap-2"><UsersIcon className="w-5 h-5" /> 第二位夥伴</h3>
                        <input type="text" placeholder="姓名/暱稱" value={person2Name} onChange={(e) => setPerson2Name(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500"/>
                        <input type="date" value={person2Date} onChange={(e) => setPerson2Date(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500"/>
                    </div>
                    <div className="md:col-span-2 border-t pt-6">
                        <h3 className="font-semibold text-gray-800 mb-4 flex items-center gap-2"><ClockIcon/> 選擇分析時點（用於流年流月互動）</h3>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">年份</label>
                                <input type="number" value={targetYear} onChange={(e) => setTargetYear(parseInt(e.target.value, 10) || new Date().getFullYear())} className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">月份</label>
                                <select value={targetMonth} onChange={(e) => setTargetMonth(parseInt(e.target.value, 10))} className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 bg-white">
                                    {[...Array(12).keys()].map(i => <option key={i+1} value={i+1}>{i+1}月</option>)}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <button onClick={handleAnalyze} className="w-full mt-6 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-md hover:from-purple-700 hover:to-pink-700 transition-colors font-semibold"><Sparkles className="inline-block w-4 h-4 mr-1" /> 分析兼容性 <Sparkles className="inline-block w-4 h-4 ml-1" /></button>
              </div>
              
              {result && (
                <div className="mt-8 space-y-6 animate-fade-in">
                  <div className="grid md:grid-cols-2 gap-6">
                    <div className="bg-white rounded-lg p-6 shadow-md">
                      <h3 className="font-semibold text-gray-800 mb-4">{result.person1.name}的生命與運勢牌組</h3>
                      <div className="space-y-2 text-sm">
                        <p><span className="font-medium text-purple-700">靈魂牌：</span>{result.person1.soulCard} - {getCardName(result.person1.soulCard)}</p>
                        <p><span className="font-medium text-pink-700">個性牌：</span>{result.person1.personalityCard} - {getCardName(result.person1.personalityCard)}</p>
                        <p><span className="font-medium text-indigo-700">互補/陰影牌 (22-Soul)：</span>{result.person1.shadowCard} - {getCardName(result.person1.shadowCard)}</p>
                        <hr className="my-2"/>
                        <p><span className="font-medium text-yellow-700">年運牌 ({result.timeframe.year})：</span>{result.person1.fortuneCards.yearlyCard} - {getCardName(result.person1.fortuneCards.yearlyCard)}</p>
                        <p><span className="font-medium text-blue-700">月運牌 ({result.timeframe.month}月)：</span>{result.person1.fortuneCards.monthlyCard} - {getCardName(result.person1.fortuneCards.monthlyCard)}</p>
                      </div>
                    </div>
                    <div className="bg-white rounded-lg p-6 shadow-md">
                      <h3 className="font-semibold text-gray-800 mb-4">{result.person2.name}的生命與運勢牌組</h3>
                      <div className="space-y-2 text-sm">
                        <p><span className="font-medium text-purple-700">靈魂牌：</span>{result.person2.soulCard} - {getCardName(result.person2.soulCard)}</p>
                        <p><span className="font-medium text-pink-700">個性牌：</span>{result.person2.personalityCard} - {getCardName(result.person2.personalityCard)}</p>
                        <p><span className="font-medium text-indigo-700">互補/陰影牌 (22-Soul)：</span>{result.person2.shadowCard} - {getCardName(result.person2.shadowCard)}</p>
                        <hr className="my-2"/>
                        <p><span className="font-medium text-yellow-700">年運牌 ({result.timeframe.year})：</span>{result.person2.fortuneCards.yearlyCard} - {getCardName(result.person2.fortuneCards.yearlyCard)}</p>
                        <p><span className="font-medium text-blue-700">月運牌 ({result.timeframe.month}月)：</span>{result.person2.fortuneCards.monthlyCard} - {getCardName(result.person2.fortuneCards.monthlyCard)}</p>
                      </div>
                    </div>
                  </div>
                  
                  <div className="bg-gradient-to-r from-purple-100 to-pink-100 rounded-lg p-6 text-center shadow-lg">
                    <h3 className="text-xl sm:text-2xl font-bold text-purple-800 mb-2">總體兼容性評級 (基於天生牌組)</h3>
                    <div className="text-xl sm:text-2xl font-semibold text-purple-700 mb-3">{result.compatibility.overall.level}</div>
                    <div className={`text-3xl sm:text-4xl font-bold ${getScoreColor(result.compatibility.overall.avgScore)} mb-4`}>{result.compatibility.overall.avgScore}%</div>
                    <p className="text-sm sm:text-base text-gray-700 max-w-2xl mx-auto leading-relaxed">{result.compatibility.overall.advice}</p>
                  </div>
                  
                   <div className="bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg p-6 shadow-lg mt-6">
                        <h3 className="text-xl sm:text-2xl font-bold text-blue-800 mb-2 text-center">
                            天生牌組互動分析
                        </h3>
                         <p className="text-center text-sm text-gray-600 max-w-2xl mx-auto">這部分分析您們天生的核心能量如何互動，揭示關係的長期潛力與課題。</p>
                   </div>
                   <div className="space-y-4">
                        {[
                          { key: 'soul', title: '靈魂層面兼容性 (核心本質)', icon: <Sparkles className="text-purple-600" />, cards: [result.person1.soulCard, result.person2.soulCard], info:"靈魂牌代表最深層的自我，此處的兼容性揭示了你們在生命目的與核心價值上的潛在連結或差異。"},
                          { key: 'personality', title: '個性層面兼容性 (日常互動)', icon: <UsersIcon className="text-pink-600" />, cards: [result.person1.personalityCard, result.person2.personalityCard], info:"個性牌反映了外在行為模式與學習課題。此兼容性關乎你們在日常相處、溝通風格及生活方式上的和諧度。"},
                          { key: 'shadow', title: '互補/陰影整合潛力 (成長課題)', icon: <Shield className="text-indigo-600" />, cards: [result.person1.shadowCard, result.person2.shadowCard], info: "此處的牌卡是通過『22-靈魂牌』計算得出，代表了靈魂需要整合的、較不熟悉或潛在的能量面向。它揭示了彼此可能觸發的深層課題，以及共同整合陰影、達成更完整自我的潛力，是關係中深刻學習的領域。" }
                        ].map(item => (
                            <CompatibilityItem key={item.key} {...item} itemKey={item.key} compatibilityInfo={result.compatibility[item.key]} infoText={item.info} isOpen={showDetails[item.key]} onToggle={() => setShowDetails(prev => ({...prev, [item.key]: !prev[item.key]}))} />
                        ))}
                   </div>


                  <div className="bg-gradient-to-r from-indigo-100 to-blue-100 rounded-lg p-6 shadow-lg mt-8">
                    <h3 className="text-xl sm:text-2xl font-bold text-indigo-800 mb-2 text-center flex items-center justify-center gap-2">
                        <ClockIcon /> 當前時運互動分析 ({result.timeframe.year}年{result.timeframe.month}月)
                    </h3>
                    <p className="text-center text-sm text-gray-600 max-w-2xl mx-auto">此部分分析您們在所選時間週期下的能量互動，提供順勢而為的指引。這屬於短期、動態的能量流，會影響天生牌組的展現方式。</p>
                  </div>
                   <div className="space-y-4">
                        {[
                          { key: 'yearly', title: `年度能量共振 (${result.timeframe.year}年)`, icon: <SunIcon className="text-yellow-600" />, cards: [result.person1.fortuneCards.yearlyCard, result.person2.fortuneCards.yearlyCard], info: `年運牌揭示了兩人在 ${result.timeframe.year} 年共同面對的宏觀主題、學習課題與發展機遇。這反映了你們在這一整年中的能量基調是和諧共振還是需要磨合。`},
                          { key: 'monthly', title: `月度主題互動 (${result.timeframe.month}月)`, icon: <MoonIcon className="text-blue-600" />, cards: [result.person1.fortuneCards.monthlyCard, result.person2.fortuneCards.monthlyCard], info: `月運牌則聚焦於 ${result.timeframe.month} 月的具體能量流動。它顯示了在年度大主題下，本月您們的互動模式、情緒焦點以及可能遇到的短期事件或挑戰。` }
                        ].map(item => (
                            <CompatibilityItem key={item.key} {...item} itemKey={item.key} compatibilityInfo={result.compatibility[item.key]} infoText={item.info} isOpen={showDetails[item.key]} onToggle={() => setShowDetails(prev => ({...prev, [item.key]: !prev[item.key]}))} />
                        ))}
                   </div>


                  <div className="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-6 shadow-lg"><h3 className="font-semibold text-gray-800 mb-4 flex items-center gap-2 text-xl"><BookOpen /> 關係發展深度建議</h3><div className="space-y-4 text-sm text-gray-700 leading-relaxed"><p>• <strong>深化靈魂連結 ({result.compatibility.soul.score}%):</strong> 定期進行深度對話，分享內心的夢想、恐懼與靈性體悟。探索你們靈魂牌 ({getCardName(result.person1.soulCard)} & {getCardName(result.person2.soulCard)}) 之間的共鳴與課題 ({result.compatibility.soul.challenges})。共同參與能滋養靈魂的活動。</p><p>• <strong>促進個性互動 ({result.compatibility.personality.score}%):</strong> 欣賞並學習彼此個性牌 ({getCardName(result.person1.personalityCard)} & {getCardName(result.person2.personalityCard)}) 的優點，尊重差異。將個性上的挑戰 ({result.compatibility.personality.challenges}) 視為學習和共同成長的機會，練習有效的溝通技巧。</p><p>• <strong>整合陰影課題 ({result.compatibility.shadow.score}%):</strong> 當衝突或不適出現時，觀察是否觸發了彼此互補/陰影牌 ({getCardName(result.person1.shadowCard)} & {getCardName(result.person2.shadowCard)}) 所代表的面向。這些互動 ({result.compatibility.shadow.challenges}) 提供了共同療癒和整合內在陰影的寶貴機會。勇敢面對，誠實分享。</p><p>• <strong>把握當前時運:</strong> 關注您們在 {result.timeframe.year} 年的年運牌 ({getCardName(result.person1.fortuneCards.yearlyCard)} & {getCardName(result.person2.fortuneCards.yearlyCard)}) 互動，以及 {result.timeframe.month} 月月運牌 ({getCardName(result.person1.fortuneCards.monthlyCard)} & {getCardName(result.person2.fortuneCards.monthlyCard)}) 的互動。這能幫助您們順應當前的能量流，共同應對機遇與挑戰。</p><p>• <strong>共同創造與成長:</strong> 設定共同的靈性或個人成長目標。利用你們牌組的綜合力量與智慧，相互支持，共同進化。記住，任何挑戰都是關係深化與個人成熟的墊腳石。持續的愛、尊重、理解與溝通是關係長久美滿的關鍵。</p><p className="mt-4 pt-4 border-t border-purple-200 text-xs text-gray-500"><InfoIcon className="inline w-3 h-3 mr-1" />免責聲明：此分析僅供個人探索與娛樂參考，不能替代專業的心理諮詢或關係輔導。請以開放和覺察的態度來對待結果。</p></div></div>
                </div>
              )}
            </div>
          );
        };
        
        // --- FORTUNE CARD CALCULATOR ---
        const FortuneCardCalculator = () => {
          const [birthDate, setBirthDate] = useState('');
          const [targetYear, setTargetYear] = useState(new Date().getFullYear());
          const [targetMonth, setTargetMonth] = useState(new Date().getMonth() + 1);
          const [result, setResult] = useState(null);
          const [showProcess, setShowProcess] = useState(false);
          const [showInfo, setShowInfo] = useState(false);

          const handleCalculate = () => {
            if (!birthDate) {
              alert('請輸入您的出生日期');
              return;
            }

            const { yearlyCard, monthlyCard } = sharedCalculateFortuneCards(birthDate, targetYear, targetMonth);
            
            // Generate steps for display
            const [bYear, bMonth, bDay] = birthDate.split('-').map(Number);
            const yearlySteps = [];
            const bYearSum = sharedSumDigits(bYear);
            const bDaySum = sharedSumDigits(bDay);
            yearlySteps.push(`出生年各位數字之和: ${bYear.toString().split('').join(' + ')} = ${bYearSum}`);
            yearlySteps.push(`出生日各位數字之和: ${bDay.toString().split('').join(' + ')} = ${bDaySum}`);
            const personalBase = bYearSum + bMonth + bDaySum;
            yearlySteps.push(`個人基數 = (年和) + (月) + (日和) = ${bYearSum} + ${bMonth} + ${bDaySum} = ${personalBase}`);
            const targetYearSum = sharedSumDigits(targetYear);
            yearlySteps.push(`目標年份數字之和: ${targetYear.toString().split('').join(' + ')} = ${targetYearSum}`);
            const yearlyValue = personalBase + targetYearSum;
            yearlySteps.push(`年運數值 = 個人基數 + 目標年份和 = ${personalBase} + ${targetYearSum} = ${yearlyValue}`);
            let yearlyCardRawForSteps = (yearlyValue > 0) ? (yearlyValue - 1) % 22 + 1 : 22;
            if (yearlyCardRawForSteps === 0) yearlyCardRawForSteps = 22;
            yearlySteps.push(`年運卡數值 (1-22) = (年運數值 - 1) % 22 + 1 = ${yearlyCardRawForSteps}`);
            if (yearlyCardRawForSteps === 22) yearlySteps.push(`結果為 22，對應塔羅牌 0 (愚者)`);

            const monthlySteps = [];
            const yearlyCardRawForCalc = yearlyCard === 0 ? 22 : yearlyCard;
            monthlySteps.push(`從年運卡數值開始: ${yearlyCardRawForCalc}`);
            const bDaySimplified = sharedReduceToSingleDigit(bDay);
            monthlySteps.push(`出生日化簡值: ${bDay} -> ${bDay.toString().split('').join('+')} -> ... -> ${bDaySimplified}`);
            const monthlyAdjustment = bMonth + bDaySimplified;
            monthlySteps.push(`個人月份調整值 = 出生月 + 出生日化簡值 = ${bMonth} + ${bDaySimplified} = ${monthlyAdjustment}`);
            const monthlyValue = yearlyCardRawForCalc + parseInt(targetMonth, 10) + monthlyAdjustment;
            monthlySteps.push(`月運數值 = 年運卡數值 + 目標月份 + 調整值 = ${yearlyCardRawForCalc} + ${targetMonth} + ${monthlyAdjustment} = ${monthlyValue}`);
            let monthlyCardRawForSteps = (monthlyValue > 0) ? (monthlyValue - 1) % 22 + 1 : 22;
            if (monthlyCardRawForSteps === 0) monthlyCardRawForSteps = 22;
            monthlySteps.push(`月運卡數值 (1-22) = (月運數值 - 1) % 22 + 1 = ${monthlyCardRawForSteps}`);
            if (monthlyCardRawForSteps === 22) monthlySteps.push(`結果為 22，對應塔羅牌 0 (愚者)`);

            setResult({
              yearlyCard,
              monthlyCard,
              steps: { yearly: yearlySteps, monthly: monthlySteps }
            });
            setShowProcess(false);
          };

          const FortuneCardInfo = () => (
             <div className="mt-8 p-6 bg-white rounded-lg shadow-md space-y-6 text-gray-700 transition-all duration-500 ease-in-out">
                <h2 className="text-2xl font-bold text-purple-800 text-center flex items-center justify-center gap-2"><BookOpen /> 年運卡和月運卡的基礎原理與具體計算方法</h2>
                
                <section>
                    <h3 className="text-xl font-semibold text-purple-700 mb-2">基礎原理</h3>
                    <div className="pl-4 border-l-4 border-purple-300">
                        <p><strong>核心概念:</strong> 年運卡和月運卡系統基於生命數字學和塔羅數秘學，通過數學計算將個人的出生信息與時間周期相結合，得出對應的塔羅牌來預測運勢趨勢。</p>
                        <p><strong>數學基礎:</strong> 主要運用數字化簡原理（將複雜數字相加化簡）與循環映射（利用模運算建立時間與卡牌的對應關係），並以個人出生日期作為獨特的個人基數。</p>
                    </div>
                </section>

                <section>
                    <h3 className="text-xl font-semibold text-purple-700 mb-2">年運卡計算方法</h3>
                    <p className="mb-2">此計算器採用基於「個人基數」の詳細步驟法：</p>
                    <div className="bg-blue-50 rounded-lg p-4 text-sm text-blue-800 space-y-2">
                        <p><strong>第一步：計算個人基數</strong><br/><code>個人基數 = (出生年各位數字之和) + (出生月) + (出生日各位數字之和)</code></p>
                        <p><strong>第二步：結合目標年份</strong><br/><code>年運數值 = 個人基數 + (目標年份各位數字之和)</code></p>
                        <p><strong>第三步：化簡至塔羅範圍 (1-22)</strong><br/><code>年運卡數值 = (年運數值 - 1) % 22 + 1</code><br/><span className="text-xs">(若結果為22，則對應塔羅牌 0 (愚者))</span></p>
                    </div>
                </section>

                <section>
                    <h3 className="text-xl font-semibold text-purple-700 mb-2">月運卡計算方法</h3>
                    <div className="bg-green-50 rounded-lg p-4 text-sm text-green-800 space-y-2">
                        <p><strong>第一步：獲得年運卡數值</strong><br/><span>使用上述方法計算出的年運卡號碼（1-22）。</span></p>
                        <p><strong>第二步：計算月份調整值</strong><br/><code>個人月份調整值 = (出生月) + (出生日化簡值)</code><br/><span className="text-xs">(出生日化簡值 = 將生日的數字相加，直到變為個位數)</span></p>
                        <p><strong>第三步：結合目標月份</strong><br/><code>月運數值 = 年運卡數值 + 目標月份 + 個人月份調整值</code><br/><code>月運卡數值 = (月運數值 - 1) % 22 + 1</code><br/><span className="text-xs">(同樣，若結果為22，則對應塔羅牌 0 (愚者))</span></p>
                    </div>
                </section>
                
                <section>
                    <h3 className="text-xl font-semibold text-purple-700 mb-2">實際應用說明</h3>
                    <div className="grid md:grid-cols-2 gap-4 text-sm">
                        <div className="bg-purple-50 p-3 rounded-lg border-l-4 border-purple-500">
                            <h4 className="font-bold text-purple-800">年運卡含義</h4>
                            <p>代表您在目標年份中，整年的主要能量趨勢、核心課題和人生主題。</p>
                        </div>
                        <div className="bg-pink-50 p-3 rounded-lg border-l-4 border-pink-500">
                            <h4 className="font-bold text-pink-800">月運卡含義</h4>
                            <p>代表在年運的大背景下，您在目標月份會遇到的具體運勢走向和需要關注的焦點。</p>
                        </div>
                    </div>
                    <p className="mt-4 text-sm"><strong>組合解讀：</strong> 年運卡是大背景，月運卡為具體表現。將兩者結合解讀，可以獲得更全面和精確的指導。例如，若年運卡是「塔」（劇變），月運卡是「星星」（希望），可能意味著在充滿變動的一年中，該月份會出現帶來希望與療癒的契機。</p>
                </section>

             </div>
          );

          const FortuneCardDisplay = ({ icon, title, cardId, bgColor, textColor, borderColor }) => {
            if (cardId === null || cardId === undefined || !cardDetails[cardId]) return null;
            const details = cardDetails[cardId];
            return (
              <div className={`${bgColor} rounded-lg p-4 shadow-md border-l-4 ${borderColor}`}>
                {/* Card Image */}
                <div className="mb-3 flex justify-center">
                  <img 
                    src={sharedGetCardImagePath(cardId)} 
                    alt={details.name}
                    className="w-full max-w-[120px] rounded-lg shadow-md object-cover border-2 border-white"
                  />
                </div>
                
                <div className="flex items-center gap-2 mb-2">
                  {icon}
                  <h3 className={`font-semibold ${textColor}`}>{title}</h3>
                </div>
                <div className={`text-3xl font-bold ${textColor} mb-1`}>
                  {cardId} - {details.name}
                </div>
                <p className={`text-md font-semibold ${textColor} mb-2`}>{details.shortMeaning}</p>
              </div>
            );
          };

          return (
            <div className="max-w-3xl mx-auto p-4 sm:p-6 bg-gradient-to-br from-indigo-100 to-blue-100 rounded-xl shadow-lg md:shadow-xl font-sans">
              <div className="text-center mb-8">
                <h1 className="text-3xl font-bold text-indigo-800 mb-2 flex items-center justify-center gap-2">
                  <ClockIcon /> 流年/流月運勢計算器
                </h1>
                <p className="text-gray-600">結合您的出生日期與特定時間，揭示年度與月度能量主題</p>
              </div>

              <div className="bg-white rounded-lg p-6 shadow-md mb-6 space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2"><Calendar />您的出生日期</label>
                        <input type="date" value={birthDate} onChange={(e) => setBirthDate(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500"/>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2"><TargetIcon />目標年份</label>
                        <input type="number" value={targetYear} onChange={(e) => setTargetYear(parseInt(e.target.value, 10) || new Date().getFullYear())} className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500"/>
                    </div>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2"><MoonIcon />目標月份</label>
                  <select value={targetMonth} onChange={(e) => setTargetMonth(parseInt(e.target.value, 10))} className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 bg-white">
                    {[...Array(12).keys()].map(i => <option key={i+1} value={i+1}>{i+1}月</option>)}
                  </select>
                </div>
                <button onClick={handleCalculate} className="w-full bg-indigo-600 text-white py-3 rounded-md hover:bg-indigo-700 transition-colors font-semibold flex items-center justify-center gap-2">
                  <Sparkles className="w-5 h-5" /> 計算我的運勢牌卡
                </button>
              </div>

              {result && (
                <div className="space-y-6 animate-fade-in">
                  <div className="bg-white rounded-lg p-6 shadow-md">
                    <h2 className="text-xl font-bold text-gray-800 mb-4">
                      您在 {targetYear} 年 {targetMonth} 月的運勢牌卡
                    </h2>
                    <div className="grid grid-cols-1 gap-6">
                       <FortuneCardDisplay 
                          icon={<SunIcon className="text-yellow-600" />} 
                          title={`${targetYear} 年運卡`}
                          cardId={result.yearlyCard}
                          bgColor="bg-yellow-100"
                          textColor="text-yellow-900"
                          borderColor="border-yellow-500"
                        />
                       <FortuneCardDisplay 
                          icon={<MoonIcon className="text-blue-600" />} 
                          title={`${targetMonth} 月運卡`}
                          cardId={result.monthlyCard}
                          bgColor="bg-blue-100"
                          textColor="text-blue-900"
                          borderColor="border-blue-500"
                        />
                    </div>
                     <div className="mt-6 p-4 bg-gray-50 rounded-lg text-sm">
                        <h4 className="font-semibold text-gray-700 mb-2">運勢解讀提示：</h4>
                        <p className="text-gray-600">您的年運卡 <strong className="text-yellow-800">{cardDetails[result.yearlyCard].name}</strong> 設定了 {targetYear} 年的整體基調與學習主題。在此大背景下，您的月運卡 <strong className="text-blue-800">{cardDetails[result.monthlyCard].name}</strong> 則揭示了 {targetMonth} 月份需要特別關注的具體能量、機遇或挑戰。
                        <br/><br/>請思考：<strong>{cardDetails[result.yearlyCard].shortMeaning.split('、')[0]}</strong> 的年度主題，在本月是如何透過 <strong>{cardDetails[result.monthlyCard].shortMeaning.split('、')[0]}</strong> 的形式顯現或被體驗的？</p>
                     </div>
                  </div>
                  
                  <button onClick={() => setShowProcess(!showProcess)} className="text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center gap-1">
                    {showProcess ? '隱藏' : '顯示'}計算過程 <span className="text-indigo-600">{showProcess ? <ChevronUp /> : <ChevronDown />}</span>
                  </button>

                  {showProcess && (
                    <div className="mt-2 p-4 bg-white rounded-lg shadow-md animate-fade-in space-y-4">
                      <div>
                        <h4 className="font-semibold text-gray-700 mb-2 border-b pb-1">年運卡計算步驟：</h4>
                        <div className="space-y-1 font-mono text-xs sm:text-sm text-gray-600">
                          {result.steps.yearly.map((step, index) => <p key={index}>{step}</p>)}
                        </div>
                      </div>
                       <div>
                        <h4 className="font-semibold text-gray-700 mb-2 border-b pb-1">月運卡計算步驟：</h4>
                        <div className="space-y-1 font-mono text-xs sm:text-sm text-gray-600">
                          {result.steps.monthly.map((step, index) => <p key={index}>{step}</p>)}
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              )}
              
              <div className="text-center mt-8">
                <button onClick={() => setShowInfo(!showInfo)} className="inline-flex items-center gap-2 px-6 py-3 bg-white text-indigo-700 rounded-full shadow-md hover:bg-indigo-50 transition-transform transform hover:scale-105">
                  <span className="font-semibold">了解運勢卡計算原理</span>
                  {showInfo ? <ChevronUp className="w-5 h-5" /> : <ChevronDown className="w-5 h-5" />}
                </button>
              </div>
              {showInfo && <FortuneCardInfo />}
            </div>
          );
        };


        // --- MAIN APP COMPONENT ---
        const App = () => {
          const [activeCalculator, setActiveCalculator] = useState('birth'); // 'birth', 'compatibility', 'fortune'

          const navButtonBaseClass = "px-3 py-2 sm:px-6 sm:py-3 rounded-lg font-semibold transition-all text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-offset-2";
          const activeNavButtonClass = "bg-purple-600 text-white shadow-lg transform scale-105 focus:ring-purple-500";
          const inactiveNavButtonClass = "bg-white text-purple-700 hover:bg-purple-100 focus:ring-purple-400";
          
          return (
            <div className="container mx-auto p-2 sm:p-4 min-h-screen">
              <nav className="text-center mb-6 sm:mb-10 p-2 sm:p-4 bg-purple-200 rounded-lg shadow-md">
                <div className="flex flex-col sm:flex-row justify-center items-center space-y-2 sm:space-y-0 sm:space-x-2 md:space-x-4">
                    <button 
                        onClick={() => setActiveCalculator('birth')}
                        className={`${navButtonBaseClass} ${activeCalculator === 'birth' ? activeNavButtonClass : inactiveNavButtonClass}`}
                    >
                        <User className="inline-block w-4 h-4 sm:w-5 sm:h-5 mr-2" /> 個體生命藍圖
                    </button>
                    <button 
                        onClick={() => setActiveCalculator('compatibility')}
                        className={`${navButtonBaseClass} ${activeCalculator === 'compatibility' ? activeNavButtonClass : inactiveNavButtonClass}`}
                    >
                        <HeartIcon className="inline-block w-4 h-4 sm:w-5 sm:h-5 mr-2" /> 雙人合盤解析
                    </button>
                    <button 
                        onClick={() => setActiveCalculator('fortune')}
                        className={`${navButtonBaseClass} ${activeCalculator === 'fortune' ? activeNavButtonClass : inactiveNavButtonClass}`}
                    >
                        <ClockIcon className="inline-block w-4 h-4 sm:w-5 sm:h-5 mr-2" /> 流年運勢分析
                    </button>
                </div>
              </nav>

              <div className="animate-fade-in">
                  {activeCalculator === 'birth' && <TarotBirthCardsCalculator />}
                  {activeCalculator === 'compatibility' && <TarotCompatibilitySystem />}
                  {activeCalculator === 'fortune' && <FortuneCardCalculator />}
              </div>
              
              <footer className="text-center text-gray-500 mt-12 pb-6 text-xs sm:text-sm">
                塔羅靈數啟迪工具 © {new Date().getFullYear()} 探索自我，深化連結，洞悉運勢。
              </footer>
            </div>
          );
        };
        
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
